{% load static %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

{% block extra_css %}
<style>
    /* Progress bar styles */
    .progress-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 5px;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        position: relative;
    }

    .step-circle {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #fff;
        border: 2px solid #ccc;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 10px;
        position: relative;
        z-index: 2;
    }

    .step.active .step-circle {
        border-color: #0077b6;
        color: #0077b6;
    }

    .step.completed .step-circle {
        background-color: #0077b6;
        border-color: #0077b6;
        color: #fff;
    }

    .step-number {
        display: block;
        font-size: 14px;
        font-weight: bold;
    }

    .step.completed .step-number {
        display: none;
    }

    .checkmark {
        display: none;
        font-size: 14px;
        font-weight: bold;
    }

    .step.completed .checkmark {
        display: block;
    }

    .step-text {
        font-size: 12px;
        color: #666;
        text-align: center;
    }

    .step.active .step-text {
        color: #0077b6;
        font-weight: bold;
    }

    .step-line {
        flex: 1;
        height: 2px;
        background-color: #ccc;
        position: relative;
        z-index: 1;
    }

    /* Form styles */
    .form-step {
        display: none;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .form-step.active {
        display: block;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }

    .header-buttons {
        display: flex;
        gap: 10px;
    }

    .view-submissions-btn {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
    }

    .save-later-btn {
        background-color: #fff;
        border: 1px solid #0077b6;
        color: #0077b6;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
    }

    .form-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
    }

    .back-btn {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
    }

    .right-buttons {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    #last-saved {
        font-size: 14px;
        color: #666;
    }

    .continue-btn {
        background-color: #0077b6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
    }

    /* Upload section styles */
    .upload-section {
        display: flex;
        gap: 30px;
    }

    .upload-info {
        flex: 1;
    }

    .upload-area {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 20px;
    }

    .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
    }

    .file-name {
        flex: 1;
    }

    .remove-file-btn {
        background-color: #e74c3c;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
    }

    .add-file-btn {
        background-color: #0077b6;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
    }

    /* Contributors section styles */
    .contributors-section {
        display: flex;
        gap: 30px;
    }

    .contributors-info {
        flex: 1;
    }

    .contributors-area {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 20px;
    }

    .contributor-card {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
    }

    .contributor-info {
        margin-bottom: 10px;
    }

    .contributor-label {
        font-weight: bold;
    }

    .add-contributor-btn {
        background-color: #0077b6;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
    }

    .remove-contributor {
        position: absolute;
        top: 10px;
        right: 10px;
        color: #ff4d4d;
        background: none;
        border: 1px solid #ff4d4d;
        border-radius: 4px;
        padding: 5px 10px;
        cursor: pointer;
        font-weight: bold;
    }

    /* Review page styles */
    .review-section {
        margin-bottom: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background-color: #f9f9f9;
        border-bottom: 1px solid #ddd;
    }

    .review-header h3 {
        margin: 0;
        font-size: 16px;
    }

    .edit-btn {
        background-color: #fff;
        border: 1px solid #0077b6;
        color: #0077b6;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

    .review-content {
        padding: 15px;
    }

    .review-item {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .review-label {
        font-weight: bold;
        margin-bottom: 5px;
        color: #555;
    }

    .review-value {
        color: #333;
    }

    .error-message {
        background-color: #fff0f0;
        border: 1px solid #ff4d4d;
        color: #ff4d4d;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: #fff;
        margin: 50px auto;
        width: 80%;
        max-width: 800px;
        border-radius: 4px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #eee;
    }

    .close-modal {
        font-size: 24px;
        cursor: pointer;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        text-align: right;
    }

    .save-btn {
        background-color: #0077b6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
    }

    /* Existing files styles */
    .existing-files {
        margin-bottom: 20px;
    }

    .existing-file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
        background-color: #f9f9f9;
    }

    .file-info {
        flex: 1;
    }

    .file-actions {
        display: flex;
        gap: 10px;
    }

    .download-file-btn {
        background-color: #0077b6;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
    }

    /* Responsive styles */
    @media (max-width: 768px) {
        .header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .header-buttons {
            margin-top: 10px;
        }
        
        .progress-bar {
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .step-text {
            font-size: 10px;
        }
        
        .upload-section,
        .contributors-section {
            flex-direction: column;
        }
        
        .form-navigation {
            flex-direction: column;
            gap: 15px;
        }
        
        .right-buttons {
            width: 100%;
            justify-content: space-between;
        }
    }

        body {
            padding-top: 20px;
            padding-bottom: 40px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
        }
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #fff;
            border: 2px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 10px;
            position: relative;
            z-index: 2;
        }
        .step.active .step-circle {
            border-color: #0d6efd;
            color: #0d6efd;
        }
        .step.completed .step-circle {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: #fff;
        }
        .step-text {
            font-size: 12px;
            color: #666;
        }
        .step.active .step-text {
            color: #0d6efd;
            font-weight: bold;
        }
        .step-line {
            position: absolute;
            top: 15px;
            left: 50%;
            width: 100%;
            height: 2px;
            background-color: #ccc;
            z-index: 1;
        }
        .step:last-child .step-line {
            display: none;
        }
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .form-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏: <span id="current-step-title">–î–µ—Ç–∞–ª–∏</span></h1>
        <div class="header-buttons">
            <a href="{% url 'article_list' %}" class="view-submissions-btn">–ú–æ–∏ —Å—Ç–∞—Ç—å–∏</a>
            <button id="save-later-top" class="save-later-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ –ø–æ—Ç–æ–º</button>
        </div>
    </div>

    <div class="progress-bar" style="display: flex; flex-direction: row;">
        <div class="step active" data-step="1">
            <div class="step-circle">
                <span class="checkmark">‚úì</span>
                <span class="step-number">1</span>
            </div>
            <div class="step-text">–î–µ—Ç–∞–ª–∏</div>
        </div>
        <div class="step-line"></div>
        <div class="step" data-step="2">
            <div class="step-circle">
                <span class="checkmark">‚úì</span>
                <span class="step-number">2</span>
            </div>
            <div class="step-text">–§–∞–π–ª—ã</div>
        </div>
        <div class="step-line"></div>
        <div class="step" data-step="3">
            <div class="step-circle">
                <span class="checkmark">‚úì</span>
                <span class="step-number">3</span>
            </div>
            <div class="step-text">–ê–≤—Ç–æ—Ä—ã</div>
        </div>
        <div class="step-line"></div>
        <div class="step" data-step="4">
            <div class="step-circle">
                <span class="checkmark">‚úì</span>
                <span class="step-number">4</span>
            </div>
            <div class="step-text">–î–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤</div>
        </div>
        <div class="step-line"></div>
        <div class="step" data-step="5">
            <div class="step-circle">
                <span class="checkmark">‚úì</span>
                <span class="step-number">5</span>
            </div>
            <div class="step-text">–û–±–∑–æ—Ä</div>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" id="article-form">
        {% csrf_token %}
        
        <div class="form-container">
            <!-- –®–∞–≥ 1: –î–µ—Ç–∞–ª–∏ -->
            <div class="form-step active" id="step-1">
                <h2>–î–µ—Ç–∞–ª–∏</h2>
                
                {% if not conference %}
                <div class="form-group">
                    <label for="id_conference">–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è*</label>
                    {{ article_form.conference }}
                    {% if article_form.conference.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.conference.errors }}</div>
                    {% endif %}
                    <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—é, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥–∞—Ç—å —Å—Ç–∞—Ç—å—é.</div>
                </div>
                {% else %}
                    <input type="hidden" name="conference" value="{{ conference.id }}">
                    <div class="form-group">
                        <label>–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è</label>
                        <p>{{ conference.title }}</p>
                    </div>
                {% endif %}
                
                <div class="form-group">
                    <label for="id_title">–ó–∞–≥–æ–ª–æ–≤–æ–∫*</label>
                    {{ article_form.title }}
                    {% if article_form.title.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.title.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="id_abstract">–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è*</label>
                    {{ article_form.abstract }}
                    {% if article_form.abstract.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.abstract.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="id_keywords">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                    {{ article_form.keywords }}
                    {% if article_form.keywords.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.keywords.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="id_references">–°—Å—ã–ª–∫–∏</label>
                    {{ article_form.references }}
                    {% if article_form.references.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.references.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label for="id_start_date">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞*</label>
                        {{ article_form.start_date }}
                        {% if article_form.start_date.errors %}
                            <div class="invalid-feedback d-block">{{ article_form.start_date.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6 form-group">
                        <label for="id_end_date">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                        {{ article_form.end_date }}
                        {% if article_form.end_date.errors %}
                            <div class="invalid-feedback d-block">{{ article_form.end_date.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ -->
            <div class="form-step" id="step-2">
                <div class="upload-section">
                    <div class="upload-info">
                        <h2>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</h2>
                        <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –≤–∞—à–µ–π —Å—Ç–∞—Ç—å–µ–π. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏, –¥–∞–Ω–Ω—ã–µ, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –¥—Ä—É–≥–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞–º –æ—Ü–µ–Ω–∏—Ç—å –≤–∞—à—É —Ä–∞–±–æ—Ç—É.</p>
                    </div>
                    <div class="upload-area">
                        <h3>–§–∞–π–ª—ã</h3>
                        
                        <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã (–ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏) -->
                        {% if article.files.all %}
                        <div class="existing-files">
                            <h4>–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h4>
                            {% for article_file in article.files.all %}
                            <div class="existing-file-item" id="existing-file-{{ article_file.id }}">
                                <div class="file-info">
                                    <strong>{{ article_file.file.name|slice:"7:" }}</strong>
                                    {% if article_file.description %}
                                    <p>{{ article_file.description }}</p>
                                    {% endif %}
                                    <small>–¢–∏–ø: {{ article_file.get_file_type_display }}</small>
                                </div>
                                <div class="file-actions">
                                    <a href="{{ article_file.file.url }}" class="download-file-btn" target="_blank">–°–∫–∞—á–∞—Ç—å</a>
                                    <button type="button" class="remove-file-btn" data-file-id="{{ article_file.id }}">–£–¥–∞–ª–∏—Ç—å</button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <div id="file-list">
                            <!-- –§–∞–π–ª—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
                        </div>
                        <input type="file" name="files" id="id_files" style="display: none;" multiple>
                        <button type="button" id="add-file-btn" class="add-file-btn">–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª</button>
                        
                        <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
                        <input type="hidden" name="deleted_files" id="deleted_files" value="">
                    </div>
                </div>
            </div>
            
            <!-- –®–∞–≥ 3: –ê–≤—Ç–æ—Ä—ã -->
            <div class="form-step" id="step-3">
                <div class="contributors-section">
                    <div class="contributors-info">
                        <h2>–ê–≤—Ç–æ—Ä—ã</h2>
                        <p>–î–æ–±–∞–≤—å—Ç–µ –≤—Å–µ—Ö –∞–≤—Ç–æ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤–Ω–µ—Å–ª–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –≤–∫–ª–∞–¥ –≤ —ç—Ç—É —Å—Ç–∞—Ç—å—é. –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω, –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –±–µ—Ä–µ—Ç –Ω–∞ —Å–µ–±—è –ø–æ–ª–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å—Ç–∞—Ç—å—é –æ—Ç –∏—Ö –∏–º–µ–Ω–∏. –í—Å–µ –∞–≤—Ç–æ—Ä—ã –¥–æ–ª–∂–Ω—ã —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∏ —Å —Ç–µ–º, —á—Ç–æ –æ–Ω–∏ —É–∫–∞–∑–∞–Ω—ã –∫–∞–∫ –∞–≤—Ç–æ—Ä—ã.</p>
                    </div>
                    <div class="contributors-area">
                        <div id="contributors-list">
                            <!-- –ê–≤—Ç–æ—Ä—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
                        </div>
                        <button type="button" id="add-contributor-btn" class="add-contributor-btn">–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∞</button>
                    </div>
                </div>
            </div>
            
            <!-- –®–∞–≥ 4: –î–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤ -->
            <div class="form-step" id="step-4">
                <h2>–î–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤</h2>
                <div class="form-group">
                    <label for="id_cover_letter">–¢–µ–º–∞—Ç–∏–∫–∞</label>
                    <p>–£–∫–∞–∂–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, —Ñ—Ä–∞–∑—ã –∏–ª–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–ø–∏—Å—ã–≤–∞—é—Ç —Ç–µ–º–∞—Ç–∏–∫—É –≤–∞—à–µ–π —Å—Ç–∞—Ç—å–∏.</p>
                    {{ article_form.cover_letter }}
                    {% if article_form.cover_letter.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.cover_letter.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="id_special_instructions">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞</label>
                    <p>–î–æ–±–∞–≤—å—Ç–µ –ª—é–±—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è, –ø–æ –≤–∞—à–µ–º—É –º–Ω–µ–Ω–∏—é, –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏–∑–≤–µ—Å—Ç–Ω–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞–º –ø—Ä–∏ –æ—Ü–µ–Ω–∫–µ –≤–∞—à–µ–π —Å—Ç–∞—Ç—å–∏.</p>
                    {{ article_form.special_instructions }}
                    {% if article_form.special_instructions.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.special_instructions.errors }}</div>
                    {% endif %}
                </div>
            </div>
            
            <!-- –®–∞–≥ 5: –û–±–∑–æ—Ä -->
            <div class="form-step" id="step-5">
                <h2>–û–±–∑–æ—Ä –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞</h2>
                <p class="review-intro">
                    –≠—Ç–æ —Å–≤–æ–¥–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—É—é –≤—ã –≤–≤–µ–ª–∏ –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –æ—Ç–ø—Ä–∞–≤–∫–∏. –í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ª—é–±—ã–µ –¥–µ—Ç–∞–ª–∏, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ –∑–¥–µ—Å—å, –Ω–∞–∂–∞–≤ –∫–Ω–æ–ø–∫—É "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞.
                </p>
                <p class="review-intro">
                    –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–ª–µ–Ω –Ω–∞—à–µ–π —Ä–µ–¥–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã –±—É–¥–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –µ–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –≤–∞–º–∏ –¥–∞–Ω–Ω—ã–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω—ã.
                </p>

                <div id="review-errors" class="error-message" style="display: none;">
                    <span class="error-icon">‚ö†</span> –ï—Å—Ç—å –æ–¥–Ω–∞ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∏–∂–µ –∏ –≤–Ω–µ—Å–∏—Ç–µ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.
                </div>

                <div class="review-section">
                    <div class="review-header">
                        <h3>–î–µ—Ç–∞–ª–∏</h3>
                        <button type="button" class="edit-btn" data-section="1">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <div class="review-content" id="review-details">
                        <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ JavaScript -->
                    </div>
                </div>

                <div class="review-section">
                    <div class="review-header">
                        <h3>–§–∞–π–ª—ã</h3>
                        <button type="button" class="edit-btn" data-section="2">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <div class="review-content" id="review-files">
                        <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ JavaScript -->
                    </div>
                </div>

                <div class="review-section">
                    <div class="review-header">
                        <h3>–ê–≤—Ç–æ—Ä—ã</h3>
                        <button type="button" class="edit-btn" data-section="3">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <div class="review-content" id="review-contributors">
                        <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ JavaScript -->
                    </div>
                </div>

                <div class="review-section">
                    <div class="review-header">
                        <h3>–î–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤</h3>
                        <button type="button" class="edit-btn" data-section="4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <div class="review-content" id="review-editors">
                        <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <div class="form-navigation">
            <button type="button" id="back-btn" class="back-btn">–ù–∞–∑–∞–¥</button>
            <div class="right-buttons">
                <span id="last-saved">–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: –ù–∏–∫–æ–≥–¥–∞</span>
                <button type="button" id="save-later-bottom" class="save-later-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ –ø–æ—Ç–æ–º</button>
                <button type="button" id="continue-btn" class="continue-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                <button type="submit" id="submit-btn" style="display: none;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </form>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∞ -->
<div id="contributor-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∞</h2>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <form id="contributor-form">
                <div class="form-group">
                    <label for="given-name">–ò–º—è <span class="required">*</span></label>
                    <input type="text" id="given-name" name="given-name" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="family-name">–§–∞–º–∏–ª–∏—è</label>
                    <input type="text" id="family-name" name="family-name" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="preferred-name">–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–æ–µ –∏–º—è</label>
                    <p class="field-description">–£–∫–∞–∂–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è, –∫–∞–∫ –∞–≤—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –≤ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ. –ü—Ä–∏–º–µ—Ä: –ü—Ä–æ—Ñ. –ò–≤–∞–Ω –ü. –°–∏–¥–æ—Ä–æ–≤</p>
                    <input type="text" id="preferred-name" name="preferred-name" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="contributor-email">Email <span class="required">*</span></label>
                    <input type="email" id="contributor-email" name="contributor-email" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="country">–°—Ç—Ä–∞–Ω–∞ <span class="required">*</span></label>
                    <select id="country" name="country" class="form-control" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É</option>
                        <option value="RU">–†–æ—Å—Å–∏—è</option>
                        <option value="UZ">–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω</option>
                        <option value="KZ">–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</option>
                        <option value="US">–°–®–ê</option>
                        <option value="GB">–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è</option>
                        <!-- –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ —Å—Ç—Ä–∞–Ω –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="homepage">URL –¥–æ–º–∞—à–Ω–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã</label>
                    <input type="url" id="homepage" name="homepage" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="orcid">ORCID ID</label>
                    <input type="text" id="orcid" name="orcid" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="bio">–ë–∏–æ–≥—Ä–∞—Ñ–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞—Ñ–µ–¥—Ä–∞ –∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—å)</label>
                    <div class="text-editor-toolbar">
                        <button type="button" class="toolbar-btn bold-btn">B</button>
                        <button type="button" class="toolbar-btn italic-btn">I</button>
                        <button type="button" class="toolbar-btn superscript-btn">x¬≤</button>
                        <button type="button" class="toolbar-btn subscript-btn">x‚ÇÇ</button>
                        <button type="button" class="toolbar-btn link-btn">üîó</button>
                    </div>
                    <textarea id="bio" name="bio" rows="5" class="form-control"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="affiliation">–ü—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å (–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è)</label>
                    <input type="text" id="affiliation" name="affiliation" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>–†–æ–ª—å –∞–≤—Ç–æ—Ä–∞</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="role" value="author" checked> –ê–≤—Ç–æ—Ä
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="role" value="translator"> –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>–°–ø–∏—Å–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–π</label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="include-in-lists" name="include-in-lists" checked>
                        –í–∫–ª—é—á–∞—Ç—å —ç—Ç–æ–≥–æ –∞–≤—Ç–æ—Ä–∞ –ø—Ä–∏ –∏–¥  name="include-in-lists" checked>
                        –í–∫–ª—é—á–∞—Ç—å —ç—Ç–æ–≥–æ –∞–≤—Ç–æ—Ä–∞ –ø—Ä–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞–≤—Ç–æ—Ä–æ–≤ –≤ —Å–ø–∏—Å–∫–∞—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π.
                    </label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" id="save-contributor-btn" class="save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const steps = document.querySelectorAll(".step");
        const formSteps = document.querySelectorAll(".form-step");
        const backBtn = document.getElementById("back-btn");
        const continueBtn = document.getElementById("continue-btn");
        const submitBtn = document.getElementById("submit-btn");
        const saveLaterBtns = document.querySelectorAll(".save-later-btn");
        const addFileBtn = document.getElementById("add-file-btn");
        const fileInput = document.getElementById("id_files");
        const fileList = document.getElementById("file-list");
        const addContributorBtn = document.getElementById("add-contributor-btn");
        const contributorsList = document.getElementById("contributors-list");
        const currentStepTitle = document.getElementById("current-step-title");
        const lastSavedSpan = document.getElementById("last-saved");
        const articleForm = document.getElementById("article-form");
        const deletedFilesInput = document.getElementById("deleted_files");

        // –≠–ª–µ–º–µ–Ω—Ç—ã –æ–±–∑–æ—Ä–∞
        const reviewDetailsSection = document.getElementById("review-details");
        const reviewFilesSection = document.getElementById("review-files");
        const reviewContributorsSection = document.getElementById("review-contributors");
        const reviewEditorsSection = document.getElementById("review-editors");
        const reviewErrorsSection = document.getElementById("review-errors");
        const editButtons = document.querySelectorAll(".edit-btn");

        // –≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        const contributorModal = document.getElementById("contributor-modal");
        const closeModal = document.querySelector(".close-modal");
        const saveContributorBtn = document.getElementById("save-contributor-btn");
        const contributorForm = document.getElementById("contributor-form");

        // –¢–µ–∫—É—â–∏–π —à–∞–≥
        let currentStep = 1;

        // –ò–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ –∞–≤—Ç–æ—Ä–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (null –¥–ª—è –Ω–æ–≤–æ–≥–æ –∞–≤—Ç–æ—Ä–∞)
        let currentContributorIndex = null;

        // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        let deletedFiles = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã
        let formData = {
            id: Date.now(), // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —ç—Ç–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
            currentStep: 1,
            completedSteps: [],
            lastSaved: null,
            details: {
                conference: "{{ conference.id }}" || "",
                title: "",
                abstract: "",
                keywords: "",
                references: "",
                startDate: "",
                endDate: ""
            },
            files: [],
            contributors: [],
            editors: {
                coverLetter: "",
                specialInstructions: ""
            }
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        loadFormData();

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        updateUI();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        backBtn.addEventListener("click", goToPreviousStep);
        continueBtn.addEventListener("click", goToNextStep);

        saveLaterBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
                saveFormData(true);
            });
        });

        addFileBtn.addEventListener("click", () => {
            fileInput.click();
        });

        fileInput.addEventListener("change", handleFileSelection);

        addContributorBtn.addEventListener("click", () => {
            openContributorModal();
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤
        document.querySelectorAll('.remove-file-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const fileId = this.getAttribute('data-file-id');
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª?')) {
                    // –î–æ–±–∞–≤–ª—è–µ–º ID —Ñ–∞–π–ª–∞ –≤ –º–∞—Å—Å–∏–≤ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
                    deletedFiles.push(fileId);
                    deletedFilesInput.value = deletedFiles.join(',');
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Ñ–∞–π–ª–∞ –≤ UI
                    document.getElementById(`existing-file-${fileId}`).style.display = 'none';
                }
            });
        });

        // –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–±–∑–æ—Ä–∞
        editButtons.forEach((btn) => {
            btn.addEventListener("click", function() {
                const sectionIndex = parseInt(this.getAttribute("data-section"));
                goToStep(sectionIndex);
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        closeModal.addEventListener("click", closeContributorModal);

        saveContributorBtn.addEventListener("click", (e) => {
            e.preventDefault();
            saveContributor();
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.addEventListener("click", (event) => {
            if (event.target === contributorModal) {
                closeContributorModal();
            }
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –≤–≤–æ–¥–∞ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
        document.querySelectorAll("input, textarea, select").forEach((input) => {
            input.addEventListener("input", () => {
                updateFormData();
            });
        });

        // –§—É–Ω–∫—Ü–∏–∏
        function updateUI() {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —à–∞–≥–æ–≤
            steps.forEach((step, index) => {
                const stepNumber = index + 1;
                if (stepNumber < currentStep) {
                    step.classList.add("completed");
                    step.classList.remove("active");
                } else if (stepNumber === currentStep) {
                    step.classList.add("active");
                    step.classList.remove("completed");
                } else {
                    step.classList.remove("active", "completed");
                }
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —à–∞–≥–æ–≤ —Ñ–æ—Ä–º—ã
            formSteps.forEach((formStep, index) => {
                const stepNumber = index + 1;
                if (stepNumber === currentStep) {
                    formStep.classList.add("active");
                } else {
                    formStep.classList.remove("active");
                }
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —à–∞–≥–∞
            const stepTitles = ["–î–µ—Ç–∞–ª–∏", "–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤", "–ê–≤—Ç–æ—Ä—ã", "–î–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤", "–û–±–∑–æ—Ä"];
            currentStepTitle.textContent = stepTitles[currentStep - 1];

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
            backBtn.style.visibility = currentStep === 1 ? "hidden" : "visible";

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
            continueBtn.textContent = currentStep === 5 ? "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" : "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å";

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            populateFormFields();

            // –ï—Å–ª–∏ –Ω–∞ —à–∞–≥–µ –æ–±–∑–æ—Ä–∞, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ–±–∑–æ—Ä–∞
            if (currentStep === 5) {
                generateReviewContent();
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            if (formData.lastSaved) {
                lastSavedSpan.textContent = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: ${formData.lastSaved}`;
            }
        }

        function populateFormFields() {
            // –î–µ—Ç–∞–ª–∏
            if (document.getElementById("id_conference")) {
                document.getElementById("id_conference").value = formData.details.conference || "";
            }
            document.getElementById("id_title").value = formData.details.title || "";
            document.getElementById("id_abstract").value = formData.details.abstract || "";
            document.getElementById("id_keywords").value = formData.details.keywords || "";
            document.getElementById("id_references").value = formData.details.references || "";
            document.getElementById("id_start_date").value = formData.details.startDate || "";
            document.getElementById("id_end_date").value = formData.details.endDate || "";

            // –§–∞–π–ª—ã
            renderFileList();

            // –ê–≤—Ç–æ—Ä—ã
            renderContributorsList();

            // –î–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤
            document.getElementById("id_cover_letter").value = formData.editors.coverLetter || "";
            document.getElementById("id_special_instructions").value = formData.editors.specialInstructions || "";
        }

        function renderFileList() {
            fileList.innerHTML = "";
            if (!formData.files || formData.files.length === 0) {
                const emptyMessage = document.createElement("p");
                emptyMessage.textContent = "–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.";
                fileList.appendChild(emptyMessage);
            } else {
                formData.files.forEach((file, index) => {
                    const fileItem = document.createElement("div");
                    fileItem.className = "file-item";

                    const fileName = document.createElement("span");
                    fileName.className = "file-name";
                    fileName.textContent = file.name;
                    fileItem.appendChild(fileName);

                    const removeButton = document.createElement("button");
                    removeButton.type = "button";
                    removeButton.textContent = "–£–¥–∞–ª–∏—Ç—å";
                    removeButton.className = "remove-file-btn";
                    removeButton.dataset.index = index;
                    removeButton.addEventListener("click", function() {
                        removeFile(parseInt(this.dataset.index));
                    });
                    fileItem.appendChild(removeButton);

                    fileList.appendChild(fileItem);
                });
            }
        }

        function handleFileSelection() {
            if (this.files.length > 0) {
                for (let i = 0; i < this.files.length; i++) {
                    const file = this.files[i];
                    if (!formData.files) formData.files = [];
                    formData.files.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        file: file // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç —Ñ–∞–π–ª–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
                    });
                }
                renderFileList();
                saveFormData(false);
            }
        }

        function removeFile(index) {
            formData.files.splice(index, 1);
            renderFileList();
            saveFormData(false);
        }

        function renderContributorsList() {
            // –û—á–∏—Å—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –∞–≤—Ç–æ—Ä–æ–≤
            contributorsList.innerHTML = "";

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤
            if (!formData.contributors || formData.contributors.length === 0) {
                const emptyMessage = document.createElement("p");
                emptyMessage.textContent = '–ê–≤—Ç–æ—Ä—ã –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∞", —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∞.';
                contributorsList.appendChild(emptyMessage);
            } else {
                formData.contributors.forEach((contributor, index) => {
                    const contributorCard = document.createElement("div");
                    contributorCard.className = "contributor-card";

                    const name = contributor.givenName + (contributor.familyName ? " " + contributor.familyName : "");
                    const displayName = contributor.preferredName || name;

                    const heading = document.createElement("h3");
                    heading.textContent = index === 0 ? "–û—Å–Ω–æ–≤–Ω–æ–π –∞–≤—Ç–æ—Ä: " + displayName : displayName;

                    const removeBtn = document.createElement("button");
                    removeBtn.type = "button";
                    removeBtn.className = "remove-contributor";
                    removeBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
                    removeBtn.dataset.index = index;
                    removeBtn.addEventListener("click", function() {
                        removeContributor(parseInt(this.dataset.index));
                    });

                    const emailInfo = document.createElement("div");
                    emailInfo.className = "contributor-info";
                    emailInfo.innerHTML = '<span class="contributor-label">Email:</span> ' + contributor.email;

                    const affiliationInfo = document.createElement("div");
                    affiliationInfo.className = "contributor-info";
                    affiliationInfo.innerHTML = '<span class="contributor-label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:</span> ' + (contributor.affiliation || "–ù–µ —É–∫–∞–∑–∞–Ω–∞");

                    const roleInfo = document.createElement("div");
                    roleInfo.className = "contributor-info";
                    roleInfo.innerHTML = '<span class="contributor-label">–†–æ–ª—å:</span> ' + (contributor.role === "translator" ? "–ü–µ—Ä–µ–≤–æ–¥—á–∏–∫" : "–ê–≤—Ç–æ—Ä");

                    const editBtn = document.createElement("button");
                    editBtn.type = "button";
                    editBtn.className = "edit-contributor-btn";
                    editBtn.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
                    editBtn.dataset.index = index;
                    editBtn.addEventListener("click", function() {
                        editContributor(parseInt(this.dataset.index));
                    });

                    contributorCard.appendChild(heading);
                    contributorCard.appendChild(removeBtn);
                    contributorCard.appendChild(emailInfo);
                    contributorCard.appendChild(affiliationInfo);
                    contributorCard.appendChild(roleInfo);
                    contributorCard.appendChild(editBtn);

                    contributorsList.appendChild(contributorCard);
                });
            }
        }

        function openContributorModal(index = null) {
            currentContributorIndex = index;

            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
            document.getElementById("given-name").value = "";
            document.getElementById("family-name").value = "";
            document.getElementById("preferred-name").value = "";
            document.getElementById("contributor-email").value = "";
            document.getElementById("country").value = "";
            document.getElementById("homepage").value = "";
            document.getElementById("orcid").value = "";
            document.getElementById("bio").value = "";
            document.getElementById("affiliation").value = "";
            document.querySelector('input[name="role"][value="author"]').checked = true;
            document.getElementById("include-in-lists").checked = true;

            // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∞–≤—Ç–æ—Ä–∞, –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
            if (index !== null && formData.contributors && formData.contributors[index]) {
                const contributor = formData.contributors[index];
                document.getElementById("given-name").value = contributor.givenName || "";
                document.getElementById("family-name").value = contributor.familyName || "";
                document.getElementById("preferred-name").value = contributor.preferredName || "";
                document.getElementById("contributor-email").value = contributor.email || "";
                document.getElementById("country").value = contributor.country || "";
                document.getElementById("homepage").value = contributor.homepage || "";
                document.getElementById("orcid").value = contributor.orcid || "";
                document.getElementById("bio").value = contributor.bio || "";
                document.getElementById("affiliation").value = contributor.affiliation || "";

                if (contributor.role === "translator") {
                    document.querySelector('input[name="role"][value="translator"]').checked = true;
                } else {
                    document.querySelector('input[name="role"][value="author"]').checked = true;
                }

                document.getElementById("include-in-lists").checked = contributor.includeInLists !== false;
            }

            // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            contributorModal.style.display = "block";
        }

        function closeContributorModal() {
            contributorModal.style.display = "none";
            currentContributorIndex = null;
        }

        function saveContributor() {
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            const givenName = document.getElementById("given-name").value.trim();
            const email = document.getElementById("contributor-email").value.trim();
            const country = document.getElementById("country").value;

            if (!givenName) {
                alert("–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.");
                return;
            }

            if (!email) {
                alert("Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.");
                return;
            }

            if (!validateEmail(email)) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email.");
                return;
            }

            if (!country) {
                alert("–°—Ç—Ä–∞–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.");
                return;
            }

            // –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –∞–≤—Ç–æ—Ä–∞
            const contributor = {
                givenName: givenName,
                familyName: document.getElementById("family-name").value.trim(),
                preferredName: document.getElementById("preferred-name").value.trim(),
                email: email,
                country: country,
                homepage: document.getElementById("homepage").value.trim(),
                orcid: document.getElementById("orcid").value.trim(),
                bio: document.getElementById("bio").value.trim(),
                affiliation: document.getElementById("affiliation").value.trim(),
                role: document.querySelector('input[name="role"]:checked').value,
                includeInLists: document.getElementById("include-in-lists").checked
            };

            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –º–∞—Å—Å–∏–≤ –∞–≤—Ç–æ—Ä–æ–≤ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (!formData.contributors) {
                formData.contributors = [];
            }

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∞
            if (currentContributorIndex !== null) {
                formData.contributors[currentContributorIndex] = contributor;
            } else {
                formData.contributors.push(contributor);
            }

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã
            saveFormData(false);

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
            renderContributorsList();

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            closeContributorModal();

            // –ü–æ–∫–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            alert("–ê–≤—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
        }

        function editContributor(index) {
            openContributorModal(index);
        }

        function removeContributor(index) {
            if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –∞–≤—Ç–æ—Ä–∞?")) {
                formData.contributors.splice(index, 1);
                renderContributorsList();
                saveFormData(false);
            }
        }

        function generateReviewContent() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏
            let hasErrors = false;

            // –†–∞–∑–¥–µ–ª –¥–µ—Ç–∞–ª–µ–π
            reviewDetailsSection.innerHTML = "";

            if (!formData.details.title) {
                addReviewError(reviewDetailsSection, "–ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.");
                hasErrors = true;
            } else {
                addReviewItem(reviewDetailsSection, "–ó–∞–≥–æ–ª–æ–≤–æ–∫", formData.details.title);
            }

            if (!formData.details.abstract) {
                addReviewError(reviewDetailsSection, "–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è", "–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.");
                hasErrors = true;
            } else {
                addReviewItem(reviewDetailsSection, "–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è", formData.details.abstract);
            }

            if (!formData.details.keywords) {
                addReviewItem(reviewDetailsSection, "–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞", "–ù–µ —É–∫–∞–∑–∞–Ω—ã");
            } else {
                addReviewItem(reviewDetailsSection, "–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞", formData.details.keywords);
            }

            addReviewItem(reviewDetailsSection, "–°—Å—ã–ª–∫–∏", formData.details.references || "–ù–µ —É–∫–∞–∑–∞–Ω—ã");
            addReviewItem(reviewDetailsSection, "–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞", formData.details.startDate || "–ù–µ —É–∫–∞–∑–∞–Ω–∞");
            addReviewItem(reviewDetailsSection, "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è", formData.details.endDate || "–ù–µ —É–∫–∞–∑–∞–Ω–∞");

            // –†–∞–∑–¥–µ–ª —Ñ–∞–π–ª–æ–≤
            reviewFilesSection.innerHTML = "";

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã, —Ç–∞–∫ –∏ –Ω–æ–≤—ã–µ
            const hasExistingFiles = document.querySelectorAll('.existing-file-item').length > 0;
            const hasNewFiles = formData.files && formData.files.length > 0;

            if (!hasExistingFiles && !hasNewFiles) {
                addReviewError(reviewFilesSection, "–í—ã –¥–æ–ª–∂–Ω—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª —Å—Ç–∞—Ç—å–∏.");
                hasErrors = true;
            } else {
                // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
                if (hasExistingFiles) {
                    const existingFilesList = document.createElement("div");
                    existingFilesList.className = "review-item";
                    
                    const existingFilesLabel = document.createElement("div");
                    existingFilesLabel.className = "review-label";
                    existingFilesLabel.textContent = "–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã";
                    
                    const existingFilesValue = document.createElement("div");
                    existingFilesValue.className = "review-value";
                    
                    const filesList = document.createElement("ul");
                    document.querySelectorAll('.existing-file-item').forEach(fileItem => {
                        if (fileItem.style.display !== 'none') { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω
                            const fileName = fileItem.querySelector('.file-info strong').textContent;
                            const li = document.createElement("li");
                            li.textContent = fileName;
                            filesList.appendChild(li);
                        }
                    });
                    
                    existingFilesValue.appendChild(filesList);
                    existingFilesList.appendChild(existingFilesLabel);
                    existingFilesList.appendChild(existingFilesValue);
                    reviewFilesSection.appendChild(existingFilesList);
                }
                
                // –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã
                if (hasNewFiles) {
                    const newFilesList = document.createElement("div");
                    newFilesList.className = "review-item";
                    
                    const newFilesLabel = document.createElement("div");
                    newFilesLabel.className = "review-label";
                    newFilesLabel.textContent = "–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã";
                    
                    const newFilesValue = document.createElement("div");
                    newFilesValue.className = "review-value";
                    
                    const filesList = document.createElement("ul");
                    formData.files.forEach(file => {
                        const li = document.createElement("li");
                        li.textContent = file.name;
                        filesList.appendChild(li);
                    });
                    
                    newFilesValue.appendChild(filesList);
                    newFilesList.appendChild(newFilesLabel);
                    newFilesList.appendChild(newFilesValue);
                    reviewFilesSection.appendChild(newFilesList);
                }
            }

            // –†–∞–∑–¥–µ–ª –∞–≤—Ç–æ—Ä–æ–≤
            reviewContributorsSection.innerHTML = "";

            if (!formData.contributors || formData.contributors.length === 0) {
                addReviewError(reviewContributorsSection, "–ù–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ—Ä—ã –¥–ª—è —ç—Ç–æ–π —Å—Ç–∞—Ç—å–∏.");
                hasErrors = true;
            } else {
                formData.contributors.forEach((contributor, index) => {
                    const contributorTitle = index === 0 ? "–û—Å–Ω–æ–≤–Ω–æ–π –∞–≤—Ç–æ—Ä" : `–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–≤—Ç–æ—Ä ${index}`;
                    const name = contributor.givenName + (contributor.familyName ? " " + contributor.familyName : "");
                    const displayName = contributor.preferredName || name;

                    const contributorItem = document.createElement("div");
                    contributorItem.className = "review-item";

                    const contributorLabel = document.createElement("div");
                    contributorLabel.className = "review-label";
                    contributorLabel.textContent = contributorTitle;

                    const contributorValue = document.createElement("div");
                    contributorValue.className = "review-value";

                    const contributorDetails = document.createElement("p");
                    contributorDetails.innerHTML = `
                        <strong>–ò–º—è:</strong> ${displayName}<br>
                        <strong>Email:</strong> ${contributor.email}<br>
                        <strong>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:</strong> ${contributor.affiliation || "–ù–µ —É–∫–∞–∑–∞–Ω–∞"}<br>
                        <strong>–†–æ–ª—å:</strong> ${contributor.role === "translator" ? "–ü–µ—Ä–µ–≤–æ–¥—á–∏–∫" : "–ê–≤—Ç–æ—Ä"}
                    `;

                    contributorValue.appendChild(contributorDetails);
                    contributorItem.appendChild(contributorLabel);
                    contributorItem.appendChild(contributorValue);
                    reviewContributorsSection.appendChild(contributorItem);
                });
            }

            // –†–∞–∑–¥–µ–ª –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤
            reviewEditorsSection.innerHTML = "";

            addReviewItem(reviewEditorsSection, "–¢–µ–º–∞—Ç–∏–∫–∞", formData.editors.coverLetter || "–ù–µ —É–∫–∞–∑–∞–Ω–∞");
            addReviewItem(reviewEditorsSection, "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞", formData.editors.specialInstructions || "–ù–µ —É–∫–∞–∑–∞–Ω—ã");

            // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
            if (hasErrors) {
                reviewErrorsSection.style.display = "block";
            } else {
                reviewErrorsSection.style.display = "none";
            }
        }

        function addReviewItem(parent, label, value) {
            const item = document.createElement("div");
            item.className = "review-item";

            const labelDiv = document.createElement("div");
            labelDiv.className = "review-label";
            labelDiv.textContent = label;

            const valueDiv = document.createElement("div");
            valueDiv.className = "review-value";
            valueDiv.textContent = value;

            item.appendChild(labelDiv);
            item.appendChild(valueDiv);
            parent.appendChild(item);
        }

        function addReviewError(parent, message, label = null) {
            if (label) {
                // –û—à–∏–±–∫–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—è
                const item = document.createElement("div");
                item.className = "review-item";

                const labelDiv = document.createElement("div");
                labelDiv.className = "review-label";
                labelDiv.textContent = label;

                const valueDiv = document.createElement("div");
                valueDiv.className = "review-value error-value";
                valueDiv.innerHTML = `<span class="error-icon">‚ö†</span> ${message}`;

                item.appendChild(labelDiv);
                item.appendChild(valueDiv);
                parent.appendChild(item);
            } else {
                // –û–±—â–∞—è –æ—à–∏–±–∫–∞
                const errorItem = document.createElement("div");
                errorItem.className = "review-item error-item";

                const errorValue = document.createElement("div");
                errorValue.className = "error-value";
                errorValue.innerHTML = `<span class="error-icon">‚ö†</span> ${message}`;

                errorItem.appendChild(errorValue);
                parent.appendChild(errorItem);
            }
        }

        function goToStep(step) {
            if (step >= 1 && step <= 5) {
                currentStep = step;
                formData.currentStep = currentStep;
                updateUI();
                saveFormData(false);
            }
        }

        function goToPreviousStep() {
            if (currentStep > 1) {
                currentStep--;
                formData.currentStep = currentStep;
                updateUI();
                saveFormData(false);
            }
        }

        function goToNextStep() {
            if (validateCurrentStep()) {
                if (currentStep < 5) {
                    currentStep++;
                    formData.currentStep = currentStep;

                    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞ –≤ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —à–∞–≥–∏, –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –µ—â–µ –Ω–µ—Ç
                    if (!formData.completedSteps.includes(currentStep - 1)) {
                        formData.completedSteps.push(currentStep - 1);
                    }

                    updateUI();
                    saveFormData(false);
                } else {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏ –≤ –æ–±–∑–æ—Ä–µ
                    const errorItems = document.querySelectorAll(".error-item, .error-value");

                    if (errorItems.length > 0) {
                        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –≤—Å–µ –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π.");
                    } else {
                        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
                        prepareFormForSubmission();
                        submitBtn.click();
                    }
                }
            }
        }

        function validateCurrentStep() {
            // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            if (currentStep === 1) {
                const title = document.getElementById("id_title").value.trim();
                const abstract = document.getElementById("id_abstract").value.trim();
                const startDate = document.getElementById("id_start_date").value;
                const conference = document.getElementById("id_conference") ? document.getElementById("id_conference").value : formData.details.conference;

                if (!title || !abstract || !startDate || !conference) {
                    alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.");
                    return false;
                }
            } else if (currentStep === 2) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã, —Ç–∞–∫ –∏ –Ω–æ–≤—ã–µ
                const hasExistingFiles = document.querySelectorAll('.existing-file-item').length > 0;
                const hasNewFiles = formData.files && formData.files.length > 0;
                
                if (!hasExistingFiles && !hasNewFiles) {
                    alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª.");
                    return false;
                }
            } else if (currentStep === 3) {
                if (!formData.contributors || formData.contributors.length === 0) {
                    alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∞–≤—Ç–æ—Ä–∞.");
                    return false;
                }
            }

            return true;
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function updateFormData() {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π
            if (currentStep === 1) {
                formData.details.conference = document.getElementById("id_conference") ? document.getElementById("id_conference").value : formData.details.conference;
                formData.details.title = document.getElementById("id_title").value;
                formData.details.abstract = document.getElementById("id_abstract").value;
                formData.details.keywords = document.getElementById("id_keywords").value;
                formData.details.references = document.getElementById("id_references").value;
                formData.details.startDate = document.getElementById("id_start_date").value;
                formData.details.endDate = document.getElementById("id_end_date").value;
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤
            if (currentStep === 4) {
                formData.editors.coverLetter = document.getElementById("id_cover_letter").value;
                formData.editors.specialInstructions = document.getElementById("id_special_instructions").value;
            }
        }

        function saveFormData(showAlert = true) {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
            updateFormData();

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞ –∏ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            formData.currentStep = currentStep;
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            formData.lastSaved = timeString;

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
            localStorage.setItem("articleFormData", JSON.stringify(formData));

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            lastSavedSpan.textContent = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: ${timeString}`;

            if (showAlert) {
                alert("–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –í—ã –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —ç—Ç–æ–π —Ñ–æ—Ä–º–µ –ø–æ–∑–∂–µ, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.");
            }
        }

        function loadFormData() {
            const savedData = localStorage.getItem("articleFormData");
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    formData = parsedData;
                    currentStep = formData.currentStep || 1;

                    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –º–∞—Å—Å–∏–≤ –∞–≤—Ç–æ—Ä–æ–≤ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                    if (!formData.contributors) {
                        formData.contributors = [];
                    }
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:", e);
                }
            }
        }

        function prepareFormForSubmission() {
            // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤
            if (formData.contributors && formData.contributors.length > 0) {
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–≥–æ –∞–≤—Ç–æ—Ä–∞ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ
                const primaryAuthor = formData.contributors[0];
                
                // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∞–≤—Ç–æ—Ä–∞
                createHiddenInput("author_given_name", primaryAuthor.givenName);
                createHiddenInput("author_family_name", primaryAuthor.familyName);
                createHiddenInput("author_email", primaryAuthor.email);
                createHiddenInput("author_country", primaryAuthor.country);
                createHiddenInput("author_affiliation", primaryAuthor.affiliation);
                
                // –î–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å JSON –∏ –ø–µ—Ä–µ–¥–∞—Ç—å –µ–≥–æ –≤ –æ–¥–Ω–æ–º –ø–æ–ª–µ
                if (formData.contributors.length > 1) {
                    const additionalAuthors = formData.contributors.slice(1);
                    createHiddenInput("additional_authors", JSON.stringify(additionalAuthors));
                }
            }
        }

        function createHiddenInput(name, value) {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = name;
            input.value = value || "";
            articleForm.appendChild(input);
        }
    });
</script>
{% endblock %}

