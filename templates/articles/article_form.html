{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
	<title>Articles</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="format-detection" content="telephone=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="author" content="">
	<meta name="keywords" content="">
	<meta name="description" content="">

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">

	<link rel="stylesheet" type="text/css" href="{% static 'css/normalize.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'icomoon/icomoon.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'css/vendor.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'style.css' %}">

</head>

<body data-bs-spy="scroll" data-bs-target="#header" tabindex="0">

	<div id="header-wrap">


		{% include "header.html" %}


</div><!--header-wrap-->

{% block extra_css %}
<style>
    /* Progress bar styles */
    .progress-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 5px;
        flex-direction: row;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        position: relative;
    }

    .step-circle {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #fff;
        border: 2px solid #ccc;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 10px;
        position: relative;
        z-index: 2;
    }

    .step.active .step-circle {
        border-color: #0077b6;
        color: #0077b6;
    }

    .step.completed .step-circle {
        background-color: #0077b6;
        border-color: #0077b6;
        color: #fff;
    }

    .step-number {
        display: block;
        font-size: 14px;
        font-weight: bold;
    }

    .step.completed .step-number {
        display: none;
    }

    .checkmark {
        display: none;
        font-size: 14px;
        font-weight: bold;
    }

    .step.completed .checkmark {
        display: block;
    }

    .step-text {
        font-size: 12px;
        color: #666;
        text-align: center;
    }

    .step.active .step-text {
        color: #0077b6;
        font-weight: bold;
    }

    .step-line {
        flex: 1;
        height: 2px;
        background-color: #ccc;
        position: relative;
        z-index: 1;
    }

    /* Form styles */
    .form-step {
        display: none;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .form-step.active {
        display: block;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }

    .header-buttons {
        display: flex;
        gap: 10px;
    }

    .view-submissions-btn {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
    }

    .save-later-btn {
        background-color: #fff;
        border: 1px solid #0077b6;
        color: #0077b6;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
    }

    .form-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
    }

    .back-btn {
        background-color: #0077b6;
        border: 1px solid #ddd;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
    }

    .right-buttons {
        align-items: center;
        gap: 10px;
    }

    #last-saved {
        font-size: 14px;
        color: #666;
    }

    .continue-btn {
        background-color: #0077b6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
    }

    /* Upload section styles */
    .upload-section {
        display: flex;
        gap: 30px;
    }

    .upload-info {
        flex: 1;
    }

    .upload-area {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 20px;
    }

    .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
    }

    .file-name {
        flex: 1;
    }

    .remove-file-btn {
        background-color: #e74c3c;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
    }

    .add-file-btn {
        background-color: #0077b6;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
    }

    /* Contributors section styles */
    .contributors-section {
        display: flex;
        gap: 30px;
    }

    .contributors-info {
        flex: 1;
    }

    .contributors-area {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 20px;
    }

    .contributor-card {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
    }

    .contributor-info {
        margin-bottom: 10px;
    }

    .contributor-label {
        font-weight: bold;
    }

    .add-contributor-btn {
        background-color: #0077b6;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
    }

    .remove-contributor {
        position: absolute;
        top: 10px;
        right: 10px;
        color: #ff4d4d;
        background: none;
        border: 1px solid #ff4d4d;
        border-radius: 4px;
        padding: 5px 10px;
        cursor: pointer;
        font-weight: bold;
    }

    /* Review page styles */
    .review-section {
        margin-bottom: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background-color: #f9f9f9;
        border-bottom: 1px solid #ddd;
    }

    .review-header h3 {
        margin: 0;
        font-size: 16px;
    }

    .edit-btn {
        background-color: #fff;
        border: 1px solid #0077b6;
        color: #0077b6;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

    .review-content {
        padding: 15px;
    }

    .review-item {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .review-label {
        font-weight: bold;
        margin-bottom: 5px;
        color: #555;
    }

    .review-value {
        color: #333;
    }

    .error-message {
        background-color: #fff0f0;
        border: 1px solid #ff4d4d;
        color: #ff4d4d;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: #fff;
        margin: 50px auto;
        width: 80%;
        max-width: 800px;
        border-radius: 4px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #eee;
    }

    .close-modal {
        font-size: 24px;
        cursor: pointer;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        text-align: right;
    }

    .save-btn {
        background-color: #0077b6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
    }

    /* Responsive styles */
    @media (max-width: 768px) {
        .header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .header-buttons {
            margin-top: 10px;
        }
        
        .progress-bar {
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .step-text {
            font-size: 10px;
        }
        
        .upload-section,
        .contributors-section {
            flex-direction: column;
        }
        
        .form-navigation {
            flex-direction: column;
            gap: 15px;
        }
        
        .right-buttons {
            width: 100%;
            justify-content: space-between;
        }
    }
</style>
{% endblock %}

<div class="container">
    <div class="header">
        <h1>Maqola yaratish: <span id="current-step-title">Tafsilotlar</span></h1>
        <div class="">
            <a href="{% url 'profile' %}?tab=business"class="save-later-btn"  > Mening maqolalarim</a>
            <button id="save-later-top" class="save-later-btn ">Keyinroq saqlash</button>
        </div>
    </div>

    <div class="progress-bar">
        <div class="step active" data-step="1">
            <div class="step-circle">
                <span class="checkmark">✓</span>
                <span class="step-number">1</span>
            </div>
            <div class="step-text">Tafsilotlar</div>
        </div>
        <div class="step" data-step="2">
            <div class="step-circle">
                <span class="checkmark">✓</span>
                <span class="step-number">2</span>
            </div>
            <div class="step-text">Fayllar</div>
        </div>
        <div class="step" data-step="3">
            <div class="step-circle">
                <span class="checkmark">✓</span>
                <span class="step-number">3</span>
            </div>
            <div class="step-text">Mualliflar</div>
        </div>
        <div class="step" data-step="4">
            <div class="step-circle">
                <span class="checkmark">✓</span>
                <span class="step-number">4</span>
            </div>
            <div class="step-text">Tahrirchilar uchun</div>
        </div>
        <div class="step" data-step="5">
            <div class="step-circle">
                <span class="checkmark">✓</span>
                <span class="step-number">5</span>
            </div>
            <div class="step-text">Ko‘rib chiqish</div>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" id="article-form">
        {% csrf_token %}
        
        <div class="form-container">
            <!-- 1-qadam: Tafsilotlar -->
            <div class="form-step active" id="step-1">
                <h2>Tafsilotlar</h2>
                
                {% if not conference %}
                <div class="form-group">
                    <label for="id_conference">Konferensiya*</label>
                    <select name="conference" id="id_conference" class="form-control">
                        <option value="">-- Konferensiyani tanlang --</option>
                        {% for conference in article_form.fields.conference.queryset %}
                            <option value="{{ conference.id }}">{{ conference.title }}</option>
                        {% endfor %}
                    </select>
                    {% if article_form.conference.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.conference.errors }}</div>
                    {% endif %}
                    <div class="form-text">Maqola topshirishni xohlagan konferensiyani tanlang.</div>
                </div>
                
                <div id="conference_detail_link" class="mt-2">
                    <a href="#" id="detail_link" class="btn btn-info" style="display: none;">Konferensiya haqida →</a>
                </div>
                
                <script>
                    document.getElementById('id_conference').addEventListener('change', function() {
                        let selectedOption = this.options[this.selectedIndex];
                        let conferenceId = selectedOption.value;
                        let detailLink = document.getElementById('detail_link');
                        
                        if (conferenceId) {
                            detailLink.href = "/conferences/" + conferenceId + "/";
                            detailLink.style.display = "inline-block";
                        } else {
                            detailLink.style.display = "none";
                        }
                    });
                </script>
                
                {% else %}
                    <input type="hidden" name="conference" value="{{ conference.id }}">
                    <div class="form-group">
                        <label>Konferensiya</label>
                        <p>{{ conference.title }}</p>
                    </div>
                {% endif %}
                
                <div class="form-group">
                    <label for="id_title">Sarlavha*</label>
                    {{ article_form.title }}
                    {% if article_form.title.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.title.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="id_abstract">Annotatsiya*</label>
                    {{ article_form.abstract }}
                    {% if article_form.abstract.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.abstract.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="id_keywords">Kalit so‘zlar (vergul bilan ajratilgan)</label>
                    {{ article_form.keywords }}
                    {% if article_form.keywords.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.keywords.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="id_references">Havolalar</label>
                    {{ article_form.references }}
                    {% if article_form.references.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.references.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label for="id_start_date">Boshlanish sanasi*</label>
                        {{ article_form.start_date }}
                        {% if article_form.start_date.errors %}
                            <div class="invalid-feedback d-block">{{ article_form.start_date.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6 form-group">
                        <label for="id_end_date">Tugash sanasi</label>
                        {{ article_form.end_date }}
                        {% if article_form.end_date.errors %}
                            <div class="invalid-feedback d-block">{{ article_form.end_date.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- 2-qadam: Fayllarni yuklash -->
            <div class="form-step" id="step-2">
                <div class="upload-section">
                    <div class="upload-info">
                        <h2>Fayllarni yuklash</h2>
                        <p>Maqolangiz bilan bog‘liq fayllarni yuklang. Maqola matni, ma’lumotlar, rasmlar va tahrirchilarga ishingizni baholashda yordam beradigan boshqa materiallarni yuklashingiz mumkin.</p>
                    </div>
                    <div class="upload-area">
                        <h3>Fayllar</h3>
                        <div id="file-list">
                            <!-- Fayllar shu yerda ko‘rsatiladi -->
                        </div>
                        <input type="file" name="files" id="id_files" style="display: none;" multiple>
                        <button type="button" id="add-file-btn" class="add-file-btn">Fayl qo‘shish</button>
                    </div>
                </div>
            </div>
            
            <!-- 3-qadam: Mualliflar -->
            <div class="form-step" id="step-3">
                <div class="contributors-section">
                    <div class="contributors-info">
                        <h2>Mualliflar</h2>
                        <p>Ushbu maqolaga katta hissa qo‘shgan barcha mualliflarni qo‘shing. Agar muallif ko‘rsatilmagan bo‘lsa, yuboruvchi ular nomidan maqola uchun to‘liq javobgarlikni o‘z zimmasiga oladi. Barcha mualliflar yuborishga va muallif sifatida ko‘rsatilishga rozilik berishlari kerak.</p>
                    </div>
                    <div class="contributors-area">
                        <div id="contributors-list">
                            <!-- Mualliflar shu yerda ko‘rsatiladi -->
                        </div>
                        <button type="button" id="add-contributor-btn" class="add-contributor-btn">Muallif qo‘shish</button>
                    </div>
                </div>
            </div>
            
            <!-- 4-qadam: Tahrirchilar uchun -->
            <div class="form-step" id="step-4">
                <h2>Tahrirchilar uchun</h2>
                <div class="form-group">
                    <label for="id_cover_letter">Mavzu</label>
                    <p>Maqolangiz mavzusini tasvirlaydigan kalit so‘zlar, iboralar yoki tasnif kodlarini ko‘rsating.</p>
                    {{ article_form.cover_letter }}
                    {% if article_form.cover_letter.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.cover_letter.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="id_special_instructions">Tahrirchi uchun izohlar</label>
                    <p>Maqolangizni baholashda tahrirchilar bilishi kerak deb hisoblagan har qanday ma’lumotni qo‘shing.</p>
                    {{ article_form.special_instructions }}
                    {% if article_form.special_instructions.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.special_instructions.errors }}</div>
                    {% endif %}
                </div>
            </div>
            
            <!-- 5-qadam: Ko‘rib chiqish -->
            <div class="form-step" id="step-5">
                <h2>Ko‘rib chiqish va yuborish</h2>
                <p class="review-intro">
                    Bu yuborishni yakunlashdan oldin kiritgan ma’lumotlaringizning qisqacha ko‘rinishi. Bu yerda ko‘rsatilgan har qanday tafsilotni har bir bo‘limning yuqori qismidagi “Tahrirlash” tugmasini bosib o‘zgartirishingiz mumkin.
                </p>
                <p class="review-intro">
                    Yuborish tugallangandan so‘ng, tahririyat jamoamiz a’zolaridan biri uni ko‘rib chiqish uchun tayinlanadi. Iltimos, kiritgan ma’lumotlaringiz iloji boricha aniq ekanligiga ishonch hosil qiling.
                </p>

                <div id="review-errors" class="error-message" style="display: none;">
                    <span class="error-icon">⚠</span> Yuborishdan oldin tuzatilishi kerak bo‘lgan bir yoki bir nechta muammolar mavjud. Iltimos, quyidagi ma’lumotlarni ko‘rib chiqing va so‘ralgan o‘zgartirishlarni kiriting.
                </div>

                <div class="review-section">
                    <div class="review-header">
                        <h3>Tafsilotlar</h3>
                        <button type="button" class="edit-btn" data-section="1">Tahrirlash</button>
                    </div>
                    <div class="review-content" id="review-details">
                        <!-- JavaScript orqali to‘ldiriladi -->
                    </div>
                </div>

                <div class="review-section">
                    <div class="review-header">
                        <h3>Fayllar</h3>
                        <button type="button" class="edit-btn" data-section="2">Tahrirlash</button>
                    </div>
                    <div class="review-content" id="review-files">
                        <!-- JavaScript orqali to‘ldiriladi -->
                    </div>
                </div>

                <div class="review-section">
                    <div class="review-header">
                        <h3>Mualliflar</h3>
                        <button type="button" class="edit-btn" data-section="3">Tahrirlash</button>
                    </div>
                    <div class="review-content" id="review-contributors">
                        <!-- JavaScript orqali to‘ldiriladi -->
                    </div>
                </div>

                <div class="review-section">
                    <div class="review-header">
                        <h3>Tahrirchilar uchun</h3>
                        <button type="button" class="edit-btn" data-section="4">Tahrirlash</button>
                    </div>
                    <div class="review-content" id="review-editors">
                        <!-- JavaScript orqali to‘ldiriladi -->
                    </div>
                </div>
            </div>
        </div>

        <div class="form-navigation">
            <button type="button" id="back-btn" class="back-btn">Orqaga</button>
            <div class="right-buttons">
                <span id="last-saved">Oxirgi saqlash: Hech qachon</span>
                <button type="button" id="save-later-bottom" class="save-later-btn">Keyinroq saqlash</button>
                <button type="button" id="continue-btn" class="continue-btn">Davom etish</button>
                <button type="submit" id="submit-btn" style="display: none;">Yuborish</button>
            </div>
        </div>
    </form>
</div>
<!-- Muallif qo‘shish uchun modal oynasi -->
<div id="contributor-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Muallif qo‘shish</h2>
            <span class="close-modal">×</span>
        </div>
        <div class="modal-body">
            <form id="contributor-form">
                <div class="form-group">
                    <label for="given-name">Ism <span class="required">*</span></label>
                    <input type="text" id="given-name" name="given-name" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="family-name">Familiya</label>
                    <input type="text" id="family-name" name="family-name" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="preferred-name">Afzal ism</label>
                    <p class="field-description">Muallif nashr qilingan ishda qanday ko‘rsatilishi kerak bo‘lgan to‘liq ismini ko‘rsating. Masalan: Prof. Ivan P. Sidorov</p>
                    <input type="text" id="preferred-name" name="preferred-name" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="contributor-email">Email <span class="required">*</span></label>
                    <input type="email" id="contributor-email" name="contributor-email" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="country">Davlat <span class="required">*</span></label>
                    <select id="country" name="country" class="form-control" required>
                        <option value="">Davlatni tanlang</option>
                        <option value="RU">Rossiya</option>
                        <option value="UZ">O‘zbekiston</option>
                        <option value="KZ">Qozog‘iston</option>
                        <option value="US">AQSh</option>
                        <option value="GB">Buyuk Britaniya</option>
                        <!-- Kerak bo‘lsa boshqa davlatlarni qo‘shing -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="homepage">Shaxsiy sahifa URL</label>
                    <input type="url" id="homepage" name="homepage" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="orcid">ORCID ID</label>
                    <input type="text" id="orcid" name="orcid" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="bio">Biografiya (masalan, kafedra va lavozim)</label>
                    <textarea id="bio" name="bio" rows="5" class="form-control"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="affiliation">Tashkilot (aloqa)</label>
                    <input type="text" id="affiliation" name="affiliation" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>Muallif roli</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="role" value="author" checked> Muallif
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="role" value="translator"> Tarjimon
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Nashrlar ro‘yxati</label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="include-in-lists" name="include-in-lists" checked>
                        Ushbu muallifni nashrlar ro‘yxatida mualliflarni aniqlashda kiritish.
                    </label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" id="save-contributor-btn" class="save-btn">Saqlash</button>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // DOM elementlari
        const steps = document.querySelectorAll(".step");
        const formSteps = document.querySelectorAll(".form-step");
        const backBtn = document.getElementById("back-btn");
        const continueBtn = document.getElementById("continue-btn");
        const submitBtn = document.getElementById("submit-btn");
        const saveLaterBtns = document.querySelectorAll(".save-later-btn");
        const addFileBtn = document.getElementById("add-file-btn");
        const fileInput = document.getElementById("id_files");
        const fileList = document.getElementById("file-list");
        const addContributorBtn = document.getElementById("add-contributor-btn");
        const contributorsList = document.getElementById("contributors-list");
        const currentStepTitle = document.getElementById("current-step-title");
        const lastSavedSpan = document.getElementById("last-saved");
        const articleForm = document.getElementById("article-form");

        // Ko‘rib chiqish elementlari
        const reviewDetailsSection = document.getElementById("review-details");
        const reviewFilesSection = document.getElementById("review-files");
        const reviewContributorsSection = document.getElementById("review-contributors");
        const reviewEditorsSection = document.getElementById("review-editors");
        const reviewErrorsSection = document.getElementById("review-errors");
        const editButtons = document.querySelectorAll(".edit-btn");

        // Modal oynaning elementlari
        const contributorModal = document.getElementById("contributor-modal");
        const closeModal = document.querySelector(".close-modal");
        const saveContributorBtn = document.getElementById("save-contributor-btn");
        const contributorForm = document.getElementById("contributor-form");

        // Joriy qadam
        let currentStep = 1;

        // Tahrirlash uchun joriy muallif indeksi (yangi muallif uchun null)
        let currentContributorIndex = null;

        // Forma ma’lumotlari obyekti
        let formData = {
            id: Date.now(), // Ushbu yuborish uchun noyob ID
            currentStep: 1,
            completedSteps: [],
            lastSaved: null,
            details: {
                conference: "{{ conference.id }}" || "",
                title: "",
                abstract: "",
                keywords: "",
                references: "",
                startDate: "",
                endDate: ""
            },
            files: [],
            contributors: [],
            editors: {
                coverLetter: "",
                specialInstructions: ""
            }
        };

        // Saqlangan ma’lumotlarni yuklash
        loadFormData();

        // UI ni yangilash
        updateUI();

        // Hodisalar ishlovchilari
        backBtn.addEventListener("click", goToPreviousStep);
        continueBtn.addEventListener("click", goToNextStep);

        saveLaterBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
                saveFormData(true);
            });
        });

        addFileBtn.addEventListener("click", () => {
            fileInput.click();
        });

        fileInput.addEventListener("change", handleFileSelection);

        addContributorBtn.addEventListener("click", () => {
            openContributorModal();
        });

        // Ko‘rib chiqish sahifasidagi tahrirlash tugmalari
        editButtons.forEach((btn) => {
            btn.addEventListener("click", function() {
                const sectionIndex = parseInt(this.getAttribute("data-section"));
                goToStep(sectionIndex);
            });
        });

        // Modal oyna hodisalari
        closeModal.addEventListener("click", closeContributorModal);

        saveContributorBtn.addEventListener("click", (e) => {
            e.preventDefault();
            saveContributor();
        });

        // Modal oynadan tashqariga bosilganda yopish
        window.addEventListener("click", (event) => {
            if (event.target === contributorModal) {
                closeContributorModal();
            }
        });

        // Forma maydonlari uchun kiritish hodisalari
        document.querySelectorAll("input, textarea, select").forEach((input) => {
            input.addEventListener("input", () => {
                updateFormData();
            });
        });

        // Funktsiyalar
        function updateUI() {
            // Qadam indikatorlarini yangilash
            steps.forEach((step, index) => {
                const stepNumber = index + 1;
                if (stepNumber < currentStep) {
                    step.classList.add("completed");
                    step.classList.remove("active");
                } else if (stepNumber === currentStep) {
                    step.classList.add("active");
                    step.classList.remove("completed");
                } else {
                    step.classList.remove("active", "completed");
                }
            });

            // Forma qadamlarining ko‘rinishini yangilash
            formSteps.forEach((formStep, index) => {
                const stepNumber = index + 1;
                if (stepNumber === currentStep) {
                    formStep.classList.add("active");
                } else {
                    formStep.classList.remove("active");
                }
            });

            // Qadam sarlavhasini yangilash
            const stepTitles = ["Tafsilotlar", "Fayllarni yuklash", "Mualliflar", "Tahrirchilar uchun", "Ko‘rib chiqish"];
            currentStepTitle.textContent = stepTitles[currentStep - 1];

            // "Orqaga" tugmasining ko‘rinishini yangilash
            backBtn.style.visibility = currentStep === 1 ? "hidden" : "visible";

            // "Davom etish" tugmasi matnini yangilash
            continueBtn.textContent = currentStep === 5 ? "Yuborish" : "Davom etish";

            // Forma maydonlarini saqlangan ma’lumotlar bilan to‘ldirish
            populateFormFields();

            // Agar ko‘rib chiqish qadamida bo‘lsa, mazmunni generatsiya qilish
            if (currentStep === 5) {
                generateReviewContent();
            }

            // Oxirgi saqlash vaqtini yangilash
            if (formData.lastSaved) {
                lastSavedSpan.textContent = `Oxirgi saqlash: ${formData.lastSaved}`;
            }
        }

        function populateFormFields() {
            // Tafsilotlar
            if (document.getElementById("id_conference")) {
                document.getElementById("id_conference").value = formData.details.conference || "";
            }
            document.getElementById("id_title").value = formData.details.title || "";
            document.getElementById("id_abstract").value = formData.details.abstract || "";
            document.getElementById("id_keywords").value = formData.details.keywords || "";
            document.getElementById("id_references").value = formData.details.references || "";
            document.getElementById("id_start_date").value = formData.details.startDate || "";
            document.getElementById("id_end_date").value = formData.details.endDate || "";

            // Fayllar
            renderFileList();

            // Mualliflar
            renderContributorsList();

            // Tahrirchilar uchun
            document.getElementById("id_cover_letter").value = formData.editors.coverLetter || "";
            document.getElementById("id_special_instructions").value = formData.editors.specialInstructions || "";
        }

        function renderFileList() {
            fileList.innerHTML = "";
            if (!formData.files || formData.files.length === 0) {
                const emptyMessage = document.createElement("p");
                emptyMessage.textContent = "Fayllar hali yuklanmagan.";
                fileList.appendChild(emptyMessage);
            } else {
                formData.files.forEach((file, index) => {
                    const fileItem = document.createElement("div");
                    fileItem.className = "file-item";

                    const fileName = document.createElement("span");
                    fileName.className = "file-name";
                    fileName.textContent = file.name;
                    fileItem.appendChild(fileName);

                    const removeButton = document.createElement("button");
                    removeButton.type = "button";
                    removeButton.textContent = "O‘chirish";
                    removeButton.className = "remove-file-btn";
                    removeButton.dataset.index = index;
                    removeButton.addEventListener("click", function() {
                        removeFile(parseInt(this.dataset.index));
                    });
                    fileItem.appendChild(removeButton);

                    fileList.appendChild(fileItem);
                });
            }
        }

        function handleFileSelection() {
            if (this.files.length > 0) {
                for (let i = 0; i < this.files.length; i++) {
                    const file = this.files[i];
                    if (!formData.files) formData.files = [];
                    formData.files.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        file: file // Keyinchalik yuborish uchun fayl obyekti saqlanadi
                    });
                }
                renderFileList();
                saveFormData(false);
            }
        }

        function removeFile(index) {
            formData.files.splice(index, 1);
            renderFileList();
            saveFormData(false);
        }

        function renderContributorsList() {
            // Mavjud mualliflar ro‘yxatini tozalash
            contributorsList.innerHTML = "";

            // Saqlangan mualliflarni qo‘shish
            if (!formData.contributors || formData.contributors.length === 0) {
                const emptyMessage = document.createElement("p");
                emptyMessage.textContent = 'Mualliflar hali qo‘shilmagan. Muallif qo‘shish uchun "Muallif qo‘shish" tugmasini bosing.';
                contributorsList.appendChild(emptyMessage);
            } else {
                formData.contributors.forEach((contributor, index) => {
                    const contributorCard = document.createElement("div");
                    contributorCard.className = "contributor-card";

                    const name = contributor.givenName + (contributor.familyName ? " " + contributor.familyName : "");
                    const displayName = contributor.preferredName || name;

                    const heading = document.createElement("h3");
                    heading.textContent = index === 0 ? "Asosiy muallif: " + displayName : displayName;

                    const removeBtn = document.createElement("button");
                    removeBtn.type = "button";
                    removeBtn.className = "remove-contributor";
                    removeBtn.textContent = "O‘chirish";
                    removeBtn.dataset.index = index;
                    removeBtn.addEventListener("click", function() {
                        removeContributor(parseInt(this.dataset.index));
                    });

                    const emailInfo = document.createElement("div");
                    emailInfo.className = "contributor-info";
                    emailInfo.innerHTML = '<span class="contributor-label">Email:</span> ' + contributor.email;

                    const affiliationInfo = document.createElement("div");
                    affiliationInfo.className = "contributor-info";
                    affiliationInfo.innerHTML = '<span class="contributor-label">Tashkilot:</span> ' + (contributor.affiliation || "Ko‘rsatilmagan");

                    const roleInfo = document.createElement("div");
                    roleInfo.className = "contributor-info";
                    roleInfo.innerHTML = '<span class="contributor-label">Rol:</span> ' + (contributor.role === "translator" ? "Tarjimon" : "Muallif");

                    const editBtn = document.createElement("button");
                    editBtn.type = "button";
                    editBtn.className = "edit-contributor-btn";
                    editBtn.textContent = "Tahrirlash";
                    editBtn.dataset.index = index;
                    editBtn.addEventListener("click", function() {
                        editContributor(parseInt(this.dataset.index));
                    });

                    contributorCard.appendChild(heading);
                    contributorCard.appendChild(removeBtn);
                    contributorCard.appendChild(emailInfo);
                    contributorCard.appendChild(affiliationInfo);
                    contributorCard.appendChild(roleInfo);
                    contributorCard.appendChild(editBtn);

                    contributorsList.appendChild(contributorCard);
                });
            }
        }

        function openContributorModal(index = null) {
            currentContributorIndex = index;

            // Forma maydonlarini tozalash
            document.getElementById("given-name").value = "";
            document.getElementById("family-name").value = "";
            document.getElementById("preferred-name").value = "";
            document.getElementById("contributor-email").value = "";
            document.getElementById("country").value = "";
            document.getElementById("homepage").value = "";
            document.getElementById("orcid").value = "";
            document.getElementById("bio").value = "";
            document.getElementById("affiliation").value = "";
            document.querySelector('input[name="role"][value="author"]').checked = true;
            document.getElementById("include-in-lists").checked = true;

            // Agar mavjud muallif tahrirlanayotgan bo‘lsa, maydonlarni to‘ldirish
            if (index !== null && formData.contributors && formData.contributors[index]) {
                const contributor = formData.contributors[index];
                document.getElementById("given-name").value = contributor.givenName || "";
                document.getElementById("family-name").value = contributor.familyName || "";
                document.getElementById("preferred-name").value = contributor.preferredName || "";
                document.getElementById("contributor-email").value = contributor.email || "";
                document.getElementById("country").value = contributor.country || "";
                document.getElementById("homepage").value = contributor.homepage || "";
                document.getElementById("orcid").value = contributor.orcid || "";
                document.getElementById("bio").value = contributor.bio || "";
                document.getElementById("affiliation").value = contributor.affiliation || "";

                if (contributor.role === "translator") {
                    document.querySelector('input[name="role"][value="translator"]').checked = true;
                } else {
                    document.querySelector('input[name="role"][value="author"]').checked = true;
                }

                document.getElementById("include-in-lists").checked = contributor.includeInLists !== false;
            }

            // Modal oynani ko‘rsatish
            contributorModal.style.display = "block";
        }

        function closeContributorModal() {
            contributorModal.style.display = "none";
            currentContributorIndex = null;
        }

        function saveContributor() {
            // Majburiy maydonlarni tekshirish
            const givenName = document.getElementById("given-name").value.trim();
            const email = document.getElementById("contributor-email").value.trim();
            const country = document.getElementById("country").value;

            if (!givenName) {
                alert("Ism majburiydir.");
                return;
            }

            if (!email) {
                alert("Email majburiydir.");
                return;
            }

            if (!validateEmail(email)) {
                alert("Iltimos, to‘g‘ri email kiriting.");
                return;
            }

            if (!country) {
                alert("Davlat majburiydir.");
                return;
            }

            // Muallif obyekti yaratish
            const contributor = {
                givenName: givenName,
                familyName: document.getElementById("family-name").value.trim(),
                preferredName: document.getElementById("preferred-name").value.trim(),
                email: email,
                country: country,
                homepage: document.getElementById("homepage").value.trim(),
                orcid: document.getElementById("orcid").value.trim(),
                bio: document.getElementById("bio").value.trim(),
                affiliation: document.getElementById("affiliation").value.trim(),
                role: document.querySelector('input[name="role"]:checked').value,
                includeInLists: document.getElementById("include-in-lists").checked
            };

            // Mualliflar massivining mavjudligiga ishonch hosil qilish
            if (!formData.contributors) {
                formData.contributors = [];
            }

            // Muallifni qo‘shish yoki yangilash
            if (currentContributorIndex !== null) {
                formData.contributors[currentContributorIndex] = contributor;
            } else {
                formData.contributors.push(contributor);
            }

            // Forma ma’lumotlarini saqlash
            saveFormData(false);

            // UI ni yangilash
            renderContributorsList();

            // Modal oynani yopish
            closeContributorModal();

            // Tasdiqlashni ko‘rsatish
            alert("Muallif muvaffaqiyatli saqlandi!");
        }

        function editContributor(index) {
            openContributorModal(index);
        }

        function removeContributor(index) {
            if (confirm("Bu muallifni o‘chirishga ishonchingiz komilmi?")) {
                formData.contributors.splice(index, 1);
                renderContributorsList();
                saveFormData(false);
            }
        }

        function generateReviewContent() {
            // Xatolarni tekshirish
            let hasErrors = false;

            // Tafsilotlar bo‘limi
            reviewDetailsSection.innerHTML = "";

            if (!formData.details.title) {
                addReviewError(reviewDetailsSection, "Sarlavha majburiydir.");
                hasErrors = true;
            } else {
                addReviewItem(reviewDetailsSection, "Sarlavha", formData.details.title);
            }

            if (!formData.details.abstract) {
                addReviewError(reviewDetailsSection, "Annotatsiya", "Bu maydon majburiydir.");
                hasErrors = true;
            } else {
                addReviewItem(reviewDetailsSection, "Annotatsiya", formData.details.abstract);
            }

            if (!formData.details.keywords) {
                addReviewItem(reviewDetailsSection, "Kalit so‘zlar", "Ko‘rsatilmagan");
            } else {
                addReviewItem(reviewDetailsSection, "Kalit so‘zlar", formData.details.keywords);
            }

            addReviewItem(reviewDetailsSection, "Havolalar", formData.details.references || "Ko‘rsatilmagan");
            addReviewItem(reviewDetailsSection, "Boshlanish sanasi", formData.details.startDate || "Ko‘rsatilmagan");
            addReviewItem(reviewDetailsSection, "Tugash sanasi", formData.details.endDate || "Ko‘rsatilmagan");

            // Fayllar bo‘limi
            reviewFilesSection.innerHTML = "";

            if (!formData.files || formData.files.length === 0) {
                addReviewError(reviewFilesSection, "Kamida bitta maqola faylini yuklashingiz kerak.");
                hasErrors = true;
            } else {
                const filesList = document.createElement("ul");
                formData.files.forEach((file) => {
                    const li = document.createElement("li");
                    li.textContent = file.name;
                    filesList.appendChild(li);
                });

                const filesItem = document.createElement("div");
                filesItem.className = "review-item";

                const filesLabel = document.createElement("div");
                filesLabel.className = "review-label";
                filesLabel.textContent = "Yuklangan fayllar";

                const filesValue = document.createElement("div");
                filesValue.className = "review-value";
                filesValue.appendChild(filesList);

                filesItem.appendChild(filesLabel);
                filesItem.appendChild(filesValue);
                reviewFilesSection.appendChild(filesItem);
            }

            // Mualliflar bo‘limi
            reviewContributorsSection.innerHTML = "";

            if (!formData.contributors || formData.contributors.length === 0) {
                addReviewError(reviewContributorsSection, "Ushbu maqola uchun mualliflar qo‘shilmagan.");
                hasErrors = true;
            } else {
                formData.contributors.forEach((contributor, index) => {
                    const contributorTitle = index === 0 ? "Asosiy muallif" : `Qo‘shimcha muallif ${index}`;
                    const name = contributor.givenName + (contributor.familyName ? " " + contributor.familyName : "");
                    const displayName = contributor.preferredName || name;

                    const contributorItem = document.createElement("div");
                    contributorItem.className = "review-item";

                    const contributorLabel = document.createElement("div");
                    contributorLabel.className = "review-label";
                    contributorLabel.textContent = contributorTitle;

                    const contributorValue = document.createElement("div");
                    contributorValue.className = "review-value";

                    const contributorDetails = document.createElement("p");
                    contributorDetails.innerHTML = `
                        <strong>Ism:</strong> ${displayName}<br>
                        <strong>Email:</strong> ${contributor.email}<br>
                        <strong>Tashkilot:</strong> ${contributor.affiliation || "Ko‘rsatilmagan"}<br>
                        <strong>Rol:</strong> ${contributor.role === "translator" ? "Tarjimon" : "Muallif"}
                    `;

                    contributorValue.appendChild(contributorDetails);
                    contributorItem.appendChild(contributorLabel);
                    contributorItem.appendChild(contributorValue);
                    reviewContributorsSection.appendChild(contributorItem);
                });
            }

            // Tahrirchilar uchun bo‘lim
            reviewEditorsSection.innerHTML = "";

            addReviewItem(reviewEditorsSection, "Mavzu", formData.editors.coverLetter || "Ko‘rsatilmagan");
            addReviewItem(reviewEditorsSection, "Tahrirchi uchun izohlar", formData.editors.specialInstructions || "Ko‘rsatilmagan");

            // Xato xabarini ko‘rsatish/yashirish
            if (hasErrors) {
                reviewErrorsSection.style.display = "block";
            } else {
                reviewErrorsSection.style.display = "none";
            }
        }

        function addReviewItem(parent, label, value) {
            const item = document.createElement("div");
            item.className = "review-item";

            const labelDiv = document.createElement("div");
            labelDiv.className = "review-label";
            labelDiv.textContent = label;

            const valueDiv = document.createElement("div");
            valueDiv.className = "review-value";
            valueDiv.textContent = value;

            item.appendChild(labelDiv);
            item.appendChild(valueDiv);
            parent.appendChild(item);
        }

        function addReviewError(parent, message, label = null) {
            if (label) {
                // Muayyan maydon uchun xato
                const item = document.createElement("div");
                item.className = "review-item";

                const labelDiv = document.createElement("div");
                labelDiv.className = "review-label";
                labelDiv.textContent = label;

                const valueDiv = document.createElement("div");
                valueDiv.className = "review-value error-value";
                valueDiv.innerHTML = `<span class="error-icon">⚠</span> ${message}`;

                item.appendChild(labelDiv);
                item.appendChild(valueDiv);
                parent.appendChild(item);
            } else {
                // Umumiy xato
                const errorItem = document.createElement("div");
                errorItem.className = "review-item error-item";

                const errorValue = document.createElement("div");
                errorValue.className = "error-value";
                errorValue.innerHTML = `<span class="error-icon">⚠</span> ${message}`;

                errorItem.appendChild(errorValue);
                parent.appendChild(errorItem);
            }
        }

        function goToStep(step) {
            if (step >= 1 && step <= 5) {
                currentStep = step;
                formData.currentStep = currentStep;
                updateUI();
                saveFormData(false);
            }
        }

        function goToPreviousStep() {
            if (currentStep > 1) {
                currentStep--;
                formData.currentStep = currentStep;
                updateUI();
                saveFormData(false);
            }
        }

        function goToNextStep() {
            if (validateCurrentStep()) {
                if (currentStep < 5) {
                    currentStep++;
                    formData.currentStep = currentStep;

                    // Joriy qadamni tugallangan qadamlarga qo‘shish
                    if (!formData.completedSteps.includes(currentStep - 1)) {
                        formData.completedSteps.push(currentStep - 1);
                    }

                    updateUI();
                    saveFormData(false);
                } else {
                    // Ko‘rib chiqishda xatolarni tekshirish
                    const errorItems = document.querySelectorAll(".error-item, .error-value");

                    if (errorItems.length > 0) {
                        alert("Iltimos, yuborishdan oldin barcha xatolarni tuzating.");
                    } else {
                        // Formani yuborish
                        prepareFormForSubmission();
                        submitBtn.click();
                    }
                }
            }
        }

        function validateCurrentStep() {
            // Majburiy maydonlar uchun oddiy tekshirish
            if (currentStep === 1) {
                const title = document.getElementById("id_title").value.trim();
                const abstract = document.getElementById("id_abstract").value.trim();
                const startDate = document.getElementById("id_start_date").value;
                const conference = document.getElementById("id_conference") ? document.getElementById("id_conference").value : formData.details.conference;

                if (!title || !abstract || !startDate || !conference) {
                    alert("Iltimos, barcha majburiy maydonlarni to‘ldiring.");
                    return false;
                }
            } else if (currentStep === 2) {
                if (!formData.files || formData.files.length === 0) {
                    alert("Iltimos, kamida bitta fayl yuklang.");
                    return false;
                }
            } else if (currentStep === 3) {
                if (!formData.contributors || formData.contributors.length === 0) {
                    alert("Iltimos, kamida bitta muallif qo‘shing.");
                    return false;
                }
            }

            return true;
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function updateFormData() {
            // Tafsilotlarni yangilash
            if (currentStep === 1) {
                formData.details.conference = document.getElementById("id_conference") ? document.getElementById("id_conference").value : formData.details.conference;
                formData.details.title = document.getElementById("id_title").value;
                formData.details.abstract = document.getElementById("id_abstract").value;
                formData.details.keywords = document.getElementById("id_keywords").value;
                formData.details.references = document.getElementById("id_references").value;
                formData.details.startDate = document.getElementById("id_start_date").value;
                formData.details.endDate = document.getElementById("id_end_date").value;
            }

            // Tahrirchilar uchun yangilash
            if (currentStep === 4) {
                formData.editors.coverLetter = document.getElementById("id_cover_letter").value;
                formData.editors.specialInstructions = document.getElementById("id_special_instructions").value;
            }
        }

        function saveFormData(showAlert = true) {
            // Saqlashdan oldin ma’lumotlarni yangilash
            updateFormData();

            // Joriy qadam va oxirgi saqlash vaqtini yangilash
            formData.currentStep = currentStep;
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            formData.lastSaved = timeString;

            // localStorage ga saqlash
            localStorage.setItem("articleFormData", JSON.stringify(formData));

            // Oxirgi saqlash vaqtini ko‘rsatish
            lastSavedSpan.textContent = `Oxirgi saqlash: ${timeString}`;

            if (showAlert) {
                alert("Sizning jarayoningiz saqlandi. Keyinroq ushbu formaga qaytib, davom ettirishingiz mumkin.");
            }
        }

        function loadFormData() {
            const savedData = localStorage.getItem("articleFormData");
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    formData = parsedData;
                    currentStep = formData.currentStep || 1;

                    // Mualliflar massivining mavjudligiga ishonch hosil qilish
                    if (!formData.contributors) {
                        formData.contributors = [];
                    }
                } catch (e) {
                    console.error("Saqlangan ma’lumotlarni yuklashda xato:", e);
                }
            }
        }

        function prepareFormForSubmission() {
            // Mualliflar ma’lumotlarini yuborish uchun yashirin maydonlar yaratish
            if (formData.contributors && formData.contributors.length > 0) {
                // Birinchi muallifni asosiy sifatida qo‘shish
                const primaryAuthor = formData.contributors[0];
                
                // Asosiy muallif uchun yashirin maydonlar yaratish
                createHiddenInput("author_given_name", primaryAuthor.givenName);
                createHiddenInput("author_family_name", primaryAuthor.familyName);
                createHiddenInput("author_email", primaryAuthor.email);
                createHiddenInput("author_country", primaryAuthor.country);
                createHiddenInput("author_affiliation", primaryAuthor.affiliation);
                
                // Qo‘shimcha mualliflar uchun JSON yaratish
                if (formData.contributors.length > 1) {
                    const additionalAuthors = formData.contributors.slice(1);
                    createHiddenInput("additional_authors", JSON.stringify(additionalAuthors));
                }
            }
        }

        function createHiddenInput(name, value) {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = name;
            input.value = value || "";
            articleForm.appendChild(input);
        }
    });
</script>
{% endblock %}