{% load i18n %}
{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
	<title>Articles</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="format-detection" content="telephone=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="author" content="">
	<meta name="keywords" content="">
	<meta name="description" content="">

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">

	<link rel="stylesheet" type="text/css" href="{% static 'css/normalize.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'icomoon/icomoon.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'css/vendor.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'style.css' %}">

</head>

<body data-bs-spy="scroll" data-bs-target="#header" tabindex="0">

	<div id="header-wrap">


		{% include "header.html" %}


</div><!--header-wrap-->

{% block extra_css %}
<style>
    /* Progress bar styles */
    .progress-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 5px;
        flex-direction: row;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        position: relative;
    }

    .step-circle {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #fff;
        border: 2px solid #ccc;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 10px;
        position: relative;
        z-index: 2;
    }

    .step.active .step-circle {
        border-color: #0077b6;
        color: #0077b6;
    }

    .step.completed .step-circle {
        background-color: #0077b6;
        border-color: #0077b6;
        color: #fff;
    }

    .step-number {
        display: block;
        font-size: 14px;
        font-weight: bold;
    }

    .step.completed .step-number {
        display: none;
    }

    .checkmark {
        display: none;
        font-size: 14px;
        font-weight: bold;
    }

    .step.completed .checkmark {
        display: block;
    }

    .step-text {
        font-size: 12px;
        color: #666;
        text-align: center;
    }

    .step.active .step-text {
        color: #0077b6;
        font-weight: bold;
    }

    .step-line {
        flex: 1;
        height: 2px;
        background-color: #ccc;
        position: relative;
        z-index: 1;
    }

    /* Form styles */
    .form-step {
        display: none;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .form-step.active {
        display: block;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }

    .header-buttons {
        display: flex;
        gap: 10px;
    }

    .view-submissions-btn {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
    }

    .save-later-btn {
        background-color: #fff;
        border: 1px solid #0077b6;
        color: #0077b6;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
    }

    .form-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
    }

    .back-btn {
        background-color: #0077b6;
        border: 1px solid #ddd;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
    }

    .right-buttons {
        align-items: center;
        gap: 10px;
    }

    #last-saved {
        font-size: 14px;
        color: #666;
    }

    .continue-btn {
        background-color: #0077b6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
    }

    /* Upload section styles */
    .upload-section {
        display: flex;
        gap: 30px;
    }

    .upload-info {
        flex: 1;
    }

    .upload-area {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 20px;
    }

    .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
    }

    .file-name {
        flex: 1;
    }

    .remove-file-btn {
        background-color: #e74c3c;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
    }

    .add-file-btn {
        background-color: #0077b6;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
    }

    /* Contributors section styles */
    .contributors-section {
        display: flex;
        gap: 30px;
    }

    .contributors-info {
        flex: 1;
    }

    .contributors-area {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 20px;
    }

    .contributor-card {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
    }

    .contributor-info {
        margin-bottom: 10px;
    }

    .contributor-label {
        font-weight: bold;
    }

    .add-contributor-btn {
        background-color: #0077b6;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
    }

    .remove-contributor {
        position: absolute;
        top: 10px;
        right: 10px;
        color: #ff4d4d;
        background: none;
        border: 1px solid #ff4d4d;
        border-radius: 4px;
        padding: 5px 10px;
        cursor: pointer;
        font-weight: bold;
    }

    /* Review page styles */
    .review-section {
        margin-bottom: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background-color: #f9f9f9;
        border-bottom: 1px solid #ddd;
    }

    .review-header h3 {
        margin: 0;
        font-size: 16px;
    }

    .edit-btn {
        background-color: #fff;
        border: 1px solid #0077b6;
        color: #0077b6;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

    .review-content {
        padding: 15px;
    }

    .review-item {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .review-label {
        font-weight: bold;
        margin-bottom: 5px;
        color: #555;
    }

    .review-value {
        color: #333;
    }

    .error-message {
        background-color: #fff0f0;
        border: 1px solid #ff4d4d;
        color: #ff4d4d;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: #fff;
        margin: 50px auto;
        width: 80%;
        max-width: 800px;
        border-radius: 4px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #eee;
    }

    .close-modal {
        font-size: 24px;
        cursor: pointer;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        text-align: right;
    }

    .save-btn {
        background-color: #0077b6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
    }

    /* Responsive styles */
    @media (max-width: 768px) {
        .header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .header-buttons {
            margin-top: 10px;
        }
        
        .progress-bar {
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .step-text {
            font-size: 10px;
        }
        
        .upload-section,
        .contributors-section {
            flex-direction: column;
        }
        
        .form-navigation {
            flex-direction: column;
            gap: 15px;
        }
        
        .right-buttons {
            width: 100%;
            justify-content: space-between;
        }
    }
</style>
{% endblock %}

<div class="container">
    <div class="header">
        <h1>{% trans "Maqola yaratish:" %} <span id="current-step-title">{% trans "Tafsilotlar" %}</span></h1>
        <div class="">
            <a href="{% url 'profile' %}?tab=business"class="save-later-btn"  > {% trans "Mening maqolalarim" %}</a>
            <button id="save-later-top" class="save-later-btn ">{% trans "Keyinroq saqlash" %}</button>
        </div>
    </div>

    <div class="progress-bar">
        <div class="step active" data-step="1">
            <div class="step-circle">
                <span class="checkmark">✓</span>
                <span class="step-number">1</span>
            </div>
            <div class="step-text">{% trans "Tafsilotlar" %}</div>
        </div>
        <div class="step" data-step="2">
            <div class="step-circle">
                <span class="checkmark">✓</span>
                <span class="step-number">2</span>
            </div>
            <div class="step-text">{% trans "Fayllar" %}</div>
        </div>
        <div class="step" data-step="3">
            <div class="step-circle">
                <span class="checkmark">✓</span>
                <span class="step-number">3</span>
            </div>
            <div class="step-text">{% trans "Mualliflar" %}</div>
        </div>
        <div class="step" data-step="4">
            <div class="step-circle">
                <span class="checkmark">✓</span>
                <span class="step-number">4</span>
            </div>
            <div class="step-text">{% trans "Tahrirchilar uchun" %}</div>
        </div>
        <div class="step" data-step="5">
            <div class="step-circle">
                <span class="checkmark">✓</span>
                <span class="step-number">5</span>
            </div>
            <div class="step-text">{% trans "Ko‘rib chiqish" %}</div>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" id="article-form">
        {% csrf_token %}
        
        <div class="form-container">
            <!-- 1-qadam: Tafsilotlar -->
            <div class="form-step active" id="step-1">
                <h2>{% trans "Tafsilotlar" %}</h2>
                
                {% if not conference %}
                <div class="form-group">
                    <label for="id_conference">{% trans "Konferensiya*" %}</label>
                    <select name="conference" id="id_conference" class="form-control">
                        <option value="">{% trans "-- Konferensiyani tanlang --" %}</option>
                        {% for conference in article_form.fields.conference.queryset %}
                            <option value="{{ conference.id }}">{{ conference.title }}</option>
                        {% endfor %}
                    </select>
                    {% if article_form.conference.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.conference.errors }}</div>
                    {% endif %}
                    <div class="form-text">{% trans "Maqola topshirishni xohlagan konferensiyani tanlang." %}</div>
                </div>
                
                <div id="conference_detail_link" class="mt-2">
                    <a href="#" id="detail_link" class="btn btn-info" style="display: none;">{% trans "Konferensiya haqida →" %}</a>
                </div>
                
                <script>
                    document.getElementById('id_conference').addEventListener('change', function() {
                        let selectedOption = this.options[this.selectedIndex];
                        let conferenceId = selectedOption.value;
                        let detailLink = document.getElementById('detail_link');
                        
                        if (conferenceId) {
                            detailLink.href = "/conferences/" + conferenceId + "/";
                            detailLink.style.display = "inline-block";
                        } else {
                            detailLink.style.display = "none";
                        }
                    });
                </script>
                
                {% else %}
                    <input type="hidden" name="conference" value="{{ conference.id }}">
                    <div class="form-group">
                        <label>{% trans "Konferensiya" %}</label>
                        <p>{{ conference.title }}</p>
                    </div>
                {% endif %}
                
                <div class="form-group">
                    <label for="id_title">{% trans "Sarlavha*" %}</label>
                    {{ article_form.title }}
                    {% if article_form.title.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.title.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="id_abstract">{% trans "Annotatsiya*" %}</label>
                    {{ article_form.abstract }}
                    {% if article_form.abstract.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.abstract.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="id_keywords">{% trans "Kalit so‘zlar (vergul bilan ajratilgan)" %}</label>
                    {{ article_form.keywords }}
                    {% if article_form.keywords.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.keywords.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="id_references">{% trans "Havolalar" %}</label>
                    {{ article_form.references }}
                    {% if article_form.references.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.references.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label for="id_start_date">{% trans "Boshlanish sanasi*" %}</label>
                        {{ article_form.start_date }}
                        {% if article_form.start_date.errors %}
                            <div class="invalid-feedback d-block">{{ article_form.start_date.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6 form-group">
                        <label for="id_end_date">{% trans "Tugash sanasi" %}</label>
                        {{ article_form.end_date }}
                        {% if article_form.end_date.errors %}
                            <div class="invalid-feedback d-block">{{ article_form.end_date.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- 2-qadam: Fayllarni yuklash -->
            <div class="form-step" id="step-2">
                <div class="upload-section">
                    <div class="upload-info">
                        <h2>{% trans "Fayllarni yuklash" %}</h2>
                        <p>{% trans "Maqolangiz bilan bog‘liq fayllarni yuklang. Maqola matni, ma’lumotlar, rasmlar va tahrirchilarga ishingizni baholashda yordam beradigan boshqa materiallarni yuklashingiz mumkin." %}</p>
                    </div>
                    <div class="upload-area">
                        <h3>{% trans "Fayllar" %}</h3>
                        <div id="file-list">
                            <!-- Fayllar shu yerda ko‘rsatiladi -->
                        </div>
                        <input type="file" name="files" id="id_files" style="display: none;" multiple>
                        <button type="button" id="add-file-btn" class="add-file-btn">{% trans "Fayl qo‘shish" %}</button>
                    </div>
                </div>
            </div>
            
            <!-- 3-qadam: Mualliflar -->
            <div class="form-step" id="step-3">
                <div class="contributors-section">
                    <div class="contributors-info">
                        <h2>{% trans "Mualliflar" %}</h2>
                        <p>{% trans "Ushbu maqolaga katta hissa qo‘shgan barcha mualliflarni qo‘shing. Agar muallif ko‘rsatilmagan bo‘lsa, yuboruvchi ular nomidan maqola uchun to‘liq javobgarlikni o‘z zimmasiga oladi. Barcha mualliflar yuborishga va muallif sifatida ko‘rsatilishga rozilik berishlari kerak." %}</p>
                    </div>
                    <div class="contributors-area">
                        <div id="contributors-list">
                            <!-- Mualliflar shu yerda ko‘rsatiladi -->
                        </div>
                        <button type="button" id="add-contributor-btn" class="add-contributor-btn">{% trans "Muallif qo‘shish" %}</button>
                    </div>
                </div>
            </div>
            
            <!-- 4-qadam: Tahrirchilar uchun -->
            <div class="form-step" id="step-4">
                <h2>{% trans "Tahrirchilar uchun" %}</h2>
                <div class="form-group">
                    <label for="id_cover_letter">{% trans "Mavzu" %}</label>
                    <p>{% trans "Maqolangiz mavzusini tasvirlaydigan kalit so‘zlar, iboralar yoki tasnif kodlarini ko‘rsating." %}</p>
                    {{ article_form.cover_letter }}
                    {% if article_form.cover_letter.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.cover_letter.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="id_special_instructions">{% trans "Tahrirchi uchun izohlar" %}</label>
                    <p>{% trans "Maqolangizni baholashda tahrirchilar bilishi kerak deb hisoblagan har qanday ma’lumotni qo‘shing." %}</p>
                    {{ article_form.special_instructions }}
                    {% if article_form.special_instructions.errors %}
                        <div class="invalid-feedback d-block">{{ article_form.special_instructions.errors }}</div>
                    {% endif %}
                </div>
            </div>
            
            <!-- 5-qadam: Ko‘rib chiqish -->
            <div class="form-step" id="step-5">
                <h2>{% trans "Ko‘rib chiqish va yuborish" %}</h2>
                <p class="review-intro">
                    {% trans "Bu yuborishni yakunlashdan oldin kiritgan ma’lumotlaringizning qisqacha ko‘rinishi. Bu yerda ko‘rsatilgan har qanday tafsilotni har bir bo‘limning yuqori qismidagi “Tahrirlash” tugmasini bosib o‘zgartirishingiz mumkin." %}
                </p>
                <p class="review-intro">
                    {% trans "Yuborish tugallangandan so‘ng, tahririyat jamoamiz a’zolaridan biri uni ko‘rib chiqish uchun tayinlanadi. Iltimos, kiritgan ma’lumotlaringiz iloji boricha aniq ekanligiga ishonch hosil qiling." %}
                </p>

                <div id="review-errors" class="error-message" style="display: none;">
                    <span class="error-icon">⚠</span> {% trans "Yuborishdan oldin tuzatilishi kerak bo‘lgan bir yoki bir nechta muammolar mavjud. Iltimos, quyidagi ma’lumotlarni ko‘rib chiqing va so‘ralgan o‘zgartirishlarni kiriting." %}
                </div>

                <div class="review-section">
                    <div class="review-header">
                        <h3>{% trans "Tafsilotlar" %}</h3>
                        <button type="button" class="edit-btn" data-section="1">{% trans "Tahrirlash" %}</button>
                    </div>
                    <div class="review-content" id="review-details">
                        <!-- JavaScript orqali to‘ldiriladi -->
                    </div>
                </div>

                <div class="review-section">
                    <div class="review-header">
                        <h3>{% trans "Fayllar" %}</h3>
                        <button type="button" class="edit-btn" data-section="2">{% trans "Tahrirlash" %}</button>
                    </div>
                    <div class="review-content" id="review-files">
                        <!-- JavaScript orqali to‘ldiriladi -->
                    </div>
                </div>

                <div class="review-section">
                    <div class="review-header">
                        <h3>{% trans "Mualliflar" %}</h3>
                        <button type="button" class="edit-btn" data-section="3">{% trans "Tahrirlash" %}</button>
                    </div>
                    <div class="review-content" id="review-contributors">
                        <!-- JavaScript orqali to‘ldiriladi -->
                    </div>
                </div>

                <div class="review-section">
                    <div class="review-header">
                        <h3>{% trans "Tahrirchilar uchun" %}</h3>
                        <button type="button" class="edit-btn" data-section="4">{% trans "Tahrirlash" %}</button>
                    </div>
                    <div class="review-content" id="review-editors">
                        <!-- JavaScript orqali to‘ldiriladi -->
                    </div>
                </div>
            </div>
        </div>

        <div class="form-navigation">
            <button type="button" id="back-btn" class="back-btn">{% trans "Orqaga" %}</button>
            <div class="right-buttons">
                <span id="last-saved">{% trans "Oxirgi saqlash: Hech qachon" %}</span>
                <button type="button" id="save-later-bottom" class="save-later-btn">{% trans "Keyinroq saqlash" %}</button>
                <button type="button" id="continue-btn" class="continue-btn">{% trans "Davom etish" %}</button>
                <button type="submit" id="submit-btn" style="display: none;">{% trans "Yuborish" %}</button>
            </div>
        </div>
    </form>
</div>
<!-- Muallif qo‘shish uchun modal oynasi -->
<div id="contributor-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>{% trans "Muallif qo‘shish" %}</h2>
            <span class="close-modal">{% trans "O'chirish" %}</span>
        </div>
        <div class="modal-body">
            <form id="contributor-form">
                <div class="form-group">
                    <label for="given-name">{% trans "Ism" %} <span class="required">*</span></label>
                    <input type="text" id="given-name" name="given-name" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="family-name">{% trans "Familiya" %}</label>
                    <input type="text" id="family-name" name="family-name" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="preferred-name">{% trans "Afzal ism" %}</label>
                    <p class="field-description">{% trans "Muallif nashr qilingan ishda qanday ko‘rsatilishi kerak bo‘lgan to‘liq ismini ko‘rsating. Masalan: Prof. Ivan P. Sidorov" %}</p>
                    <input type="text" id="preferred-name" name="preferred-name" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="contributor-email">{% trans "Email" %} <span class="required">*</span></label>
                    <input type="email" id="contributor-email" name="contributor-email" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="country">{% trans "Davlat" %} <span class="required">*</span></label>
                    <select id="country" name="country" class="form-control" required>
                        <option value="">{% trans "Davlatni tanlang" %}</option>
                        <option value="RU">{% trans "Rossiya" %}</option>
                        <option value="UZ">{% trans "O‘zbekiston" %}</option>
                        <option value="KZ">{% trans "Qozog‘iston" %}</option>
                        <option value="US">{% trans "AQSh" %}</option>
                        <option value="GB">{% trans "Buyuk Britaniya" %}</option>
                        <!-- Kerak bo‘lsa boshqa davlatlarni qo‘shing -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="homepage">{% trans "Shaxsiy sahifa URL" %}</label>
                    <input type="url" id="homepage" name="homepage" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="orcid">{% trans "ORCID ID" %}</label>
                    <input type="text" id="orcid" name="orcid" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="bio">{% trans "Biografiya (masalan, kafedra va lavozim)" %}</label>
                    <textarea id="bio" name="bio" rows="5" class="form-control"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="affiliation">{% trans "Tashkilot (aloqa)" %}</label>
                    <input type="text" id="affiliation" name="affiliation" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>{% trans "Muallif roli" %}</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="role" value="author" checked> {% trans "Muallif" %}
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="role" value="translator"> {% trans "Tarjimon" %}
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>{% trans "Nashrlar ro‘yxati" %}</label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="include-in-lists" name="include-in-lists" checked>
                        {% trans "Ushbu muallifni nashrlar ro‘yxatida mualliflarni aniqlashda kiritish." %}
                    </label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" id="save-contributor-btn" class="save-btn">{% trans "Saqlash" %}</button>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
    // Variables
    const form = document.getElementById('article-form');
    const steps = document.querySelectorAll('.form-step');
    const progressSteps = document.querySelectorAll('.step');
    const backBtn = document.getElementById('back-btn');
    const continueBtn = document.getElementById('continue-btn');
    const submitBtn = document.getElementById('submit-btn');
    const saveLaterBtns = document.querySelectorAll('.save-later-btn');
    const currentStepTitle = document.getElementById('current-step-title');
    const stepTitles = ['Tafsilotlar', 'Fayllar', 'Mualliflar', 'Tahrirchilar uchun', 'Ko\'rib chiqish'];
    
    let currentStep = 0;
    let articleId = null;
    let contributors = [];
    let uploadedFiles = [];
    
    // Initialize the form
    function initForm() {
        updateStepVisibility();
        updateProgressBar();
        updateButtons();
        
        // Hide back button on first step
        if (currentStep === 0) {
            backBtn.style.display = 'none';
        }
        
        // Load saved data if available
        const savedArticleId = localStorage.getItem('article_draft_id');
        if (savedArticleId) {
            articleId = savedArticleId;
            loadSavedDraft(articleId);
        }
    }
    
    // Update which step is visible
    function updateStepVisibility() {
        steps.forEach((step, index) => {
            if (index === currentStep) {
                step.classList.add('active');
            } else {
                step.classList.remove('active');
            }
        });
        
        // Update the step title
        currentStepTitle.textContent = stepTitles[currentStep];
    }
    
    // Update the progress bar
    function updateProgressBar() {
        progressSteps.forEach((step, index) => {
            if (index < currentStep) {
                step.classList.add('completed');
                step.classList.remove('active');
            } else if (index === currentStep) {
                step.classList.add('active');
                step.classList.remove('completed');
            } else {
                step.classList.remove('active');
                step.classList.remove('completed');
            }
        });
    }
    
    // Update button visibility
    function updateButtons() {
        if (currentStep === 0) {
            backBtn.style.display = 'none';
        } else {
            backBtn.style.display = 'block';
        }
        
        if (currentStep === steps.length - 1) {
            continueBtn.style.display = 'none';
            submitBtn.style.display = 'block';
        } else {
            continueBtn.style.display = 'block';
            submitBtn.style.display = 'none';
        }
    }
    
    // Go to the next step
    function nextStep() {
        if (validateCurrentStep()) {
            if (currentStep < steps.length - 1) {
                currentStep++;
                updateStepVisibility();
                updateProgressBar();
                updateButtons();
                window.scrollTo(0, 0);
                
                // If we're on the review step, populate the review content
                if (currentStep === steps.length - 1) {
                    populateReviewContent();
                }
            }
        }
    }
    
    // Go to the previous step
    function prevStep() {
        if (currentStep > 0) {
            currentStep--;
            updateStepVisibility();
            updateProgressBar();
            updateButtons();
            window.scrollTo(0, 0);
        }
    }
    
    // Validate the current step
    function validateCurrentStep() {
        if (currentStep === 0) {
            // Validate details step
            const title = document.getElementById('id_title').value;
            const abstract = document.getElementById('id_abstract').value;
            const conference = document.getElementById('id_conference');
            
            if (!title) {
                alert('{% trans "Iltimos, maqola sarlavhasini kiriting."%}');
                return false;
            }
            
            if (!abstract) {
                alert('{% trans "Iltimos, maqola annotatsiyasini kiriting."%}');
                return false;
            }
            
            if (conference && conference.value === '') {
                alert('{% trans "Iltimos, konferensiyani tanlang."%}');
                return false;
            }
            
            return true;
        } else if (currentStep === 1) {
            // Validate files step
            if (uploadedFiles.length === 0) {
                alert('{% trans "Iltimos, kamida bitta fayl yuklang."%}');
                return false;
            }
            return true;
        } else if (currentStep === 2) {
            // Validate authors step
            if (contributors.length === 0) {
                alert('{% trans "Iltimos, kamida bitta muallif qoshing."%}');
                return false;
            }
            return true;
        }
        
        return true;
    }
    
    // Save the current draft
    function saveDraft() {
        const formData = new FormData(form);
        
        // Add article ID if we have one
        if (articleId) {
            formData.append('article_id', articleId);
        }
        
        // Add contributors
        contributors.forEach((contributor, index) => {
            formData.append('contributors[]', JSON.stringify(contributor));
        });
        
        // Make AJAX request to save draft
        fetch('/articles/save-draft/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update article ID and last saved time
                articleId = data.article_id;
                localStorage.setItem('article_draft_id', articleId);
                
                const lastSavedElement = document.getElementById('last-saved');
                if (lastSavedElement) {
                    lastSavedElement.textContent = '{% trans "Oxirgi saqlash: "%}' + data.last_saved;
                }
                
                alert('{% trans "Maqola qoralama sifatida saqlandi."%}');
            } else {
                alert('{% trans "Xatolik: "%}' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "Saqlashda xatolik yuz berdi."%}');
        });
    }
    
    // Load a saved draft
    function loadSavedDraft(id) {
        fetch(`/articles/get-draft/${id}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Populate form fields
                document.getElementById('id_title').value = data.article.title || '';
                document.getElementById('id_abstract').value = data.article.abstract || '';
                document.getElementById('id_keywords').value = data.article.keywords || '';
                document.getElementById('id_references').value = data.article.references || '';
                document.getElementById('id_cover_letter').value = data.article.cover_letter || '';
                document.getElementById('id_special_instructions').value = data.article.special_instructions || '';
                
                if (data.article.start_date) {
                    document.getElementById('id_start_date').value = data.article.start_date;
                }
                
                if (data.article.end_date) {
                    document.getElementById('id_end_date').value = data.article.end_date;
                }
                
                if (data.article.conference_id) {
                    const conferenceSelect = document.getElementById('id_conference');
                    if (conferenceSelect) {
                        conferenceSelect.value = data.article.conference_id;
                    }
                }
                
                // Load contributors
                contributors = data.contributors || [];
                renderContributors();
                
                // Load files
                uploadedFiles = data.files || [];
                renderFiles();
                
                // Update last saved time
                const lastSavedElement = document.getElementById('last-saved');
                if (lastSavedElement && data.article.last_saved) {
                    lastSavedElement.textContent = '{% trans "Oxirgi saqlash: "%}' + data.article.last_saved;
                }
            } else {
                alert('{% trans "Xatolik: "%}' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "Qoralamani yuklashda xatolik yuz berdi."%}');
        });
    }
    
    // Populate the review content
    function populateReviewContent() {
        // Details section
        const reviewDetails = document.getElementById('review-details');
        reviewDetails.innerHTML = '';
        
        const conferenceSelect = document.getElementById('id_conference');
        let conferenceText = '';
        if (conferenceSelect) {
            const selectedOption = conferenceSelect.options[conferenceSelect.selectedIndex];
            conferenceText = selectedOption ? selectedOption.text : '';
        }
        
        const detailsItems = [
            { label: '{% trans "Konferensiya" %}', value: conferenceText },
            { label: '{% trans "Sarlavha" %}', value: document.getElementById('id_title').value },
            { label: '{% trans "Annotatsiya" %}', value: document.getElementById('id_abstract').value },
            { label: '{% trans "Kalit sozlar" %}', value: document.getElementById('id_keywords').value },
            { label: '{% trans "Havolalar" %}', value: document.getElementById('id_references').value },
            { label: '{% trans "Boshlanish sanasi" %}', value: document.getElementById('id_start_date').value },
            { label: '{% trans "Tugash sanasi" %}', value: document.getElementById('id_end_date').value }
        ];
        
        detailsItems.forEach(item => {
            if (item.value) {
                const itemElement = document.createElement('div');
                itemElement.className = 'review-item';
                itemElement.innerHTML = `
                    <div class="review-label">${item.label}</div>
                    <div class="review-value">${item.value}</div>
                `;
                reviewDetails.appendChild(itemElement);
            }
        });
        
        // Files section
        const reviewFiles = document.getElementById('review-files');
        reviewFiles.innerHTML = '';
        
        if (uploadedFiles.length > 0) {
            uploadedFiles.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.className = 'review-item';
                fileElement.innerHTML = `
                    <div class="review-label">{% trans "Fayl" %}</div>
                    <div class="review-value">${file.name}</div>
                `;
                reviewFiles.appendChild(fileElement);
            });
        } else {
            reviewFiles.innerHTML = '<div class="review-item">{% trans "Fayllar yuklanmagan</div>';
        }
        
        // Contributors section
        const reviewContributors = document.getElementById('review-contributors');
        reviewContributors.innerHTML = '';
        
        if (contributors.length > 0) {
            contributors.forEach((contributor, index) => {
                const contributorElement = document.createElement('div');
                contributorElement.className = 'review-item';
                contributorElement.innerHTML = `
                    <div class="review-label">{% trans "Muallif"%} ${index + 1}</div>
                    <div class="review-value">
                        <strong>${contributor.given_name} ${contributor.family_name || ''}</strong><br>
                        Email: ${contributor.email}<br>
                        ${contributor.affiliation ? '{% trans "Tashkilot: "%}' + contributor.affiliation + '<br>' : ''}
                        ${contributor.country ? '{% trans "Davlat: "%}' + contributor.country + '<br>' : ''}
                    </div>
                `;
                reviewContributors.appendChild(contributorElement);
            });
        } else {
            reviewContributors.innerHTML = '<div class="review-item">{% trans "Mualliflar qoshilmagan" %}</div>';
        }
        
        // Editors section
        const reviewEditors = document.getElementById('review-editors');
        reviewEditors.innerHTML = '';
        
        const editorsItems = [
            { label: '{% trans "Mavzu" %}', value: document.getElementById('id_cover_letter').value },
            { label: '{% trans "Tahrirchi uchun izohlar" %}', value: document.getElementById('id_special_instructions').value }
        ];
        
        editorsItems.forEach(item => {
            if (item.value) {
                const itemElement = document.createElement('div');
                itemElement.className = 'review-item';
                itemElement.innerHTML = `
                    <div class="review-label">${item.label}</div>
                    <div class="review-value">${item.value}</div>
                `;
                reviewEditors.appendChild(itemElement);
            }
        });
        
        // Check for validation errors
        const hasErrors = validateAllSteps();
        const reviewErrors = document.getElementById('review-errors');
        if (hasErrors) {
            reviewErrors.style.display = 'block';
        } else {
            reviewErrors.style.display = 'none';
        }
    }
    
    // Validate all steps for the review page
    function validateAllSteps() {
        let hasErrors = false;
        
        // Check details
        const title = document.getElementById('id_title').value;
        const abstract = document.getElementById('id_abstract').value;
        const conference = document.getElementById('id_conference');
        
        if (!title || !abstract || (conference && conference.value === '')) {
            hasErrors = true;
        }
        
        // Check files
        if (uploadedFiles.length === 0) {
            hasErrors = true;
        }
        
        // Check authors
        if (contributors.length === 0) {
            hasErrors = true;
        }
        
        return hasErrors;
    }
    
    // File handling functions
    function handleFileUpload(files) {
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            uploadedFiles.push(file);
        }
        renderFiles();
    }
    
    function renderFiles() {
        const fileList = document.getElementById('file-list');
        fileList.innerHTML = '';
        
        uploadedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-name">${file.name}</div>
                <button type="button" class="remove-file-btn" data-index="${index}">{% trans "Olib tashlash" %}</button>
            `;
            fileList.appendChild(fileItem);
        });
        
        // Add event listeners to remove buttons
        document.querySelectorAll('.remove-file-btn').forEach(button => {
            button.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                uploadedFiles.splice(index, 1);
                renderFiles();
            });
        });
    }
    
    // Contributor handling functions
    function openContributorModal() {
        const modal = document.getElementById('contributor-modal');
        modal.style.display = 'block';
        
        // Reset the form
        document.getElementById('contributor-form').reset();
    }
    
    function closeContributorModal() {
        const modal = document.getElementById('contributor-modal');
        modal.style.display = 'none';
    }
    
    function saveContributor() {
        const givenName = document.getElementById('given-name').value;
        const familyName = document.getElementById('family-name').value;
        const preferredName = document.getElementById('preferred-name').value;
        const email = document.getElementById('contributor-email').value;
        const country = document.getElementById('country').value;
        const homepage = document.getElementById('homepage').value;
        const orcid = document.getElementById('orcid').value;
        const bio = document.getElementById('bio').value;
        const affiliation = document.getElementById('affiliation').value;
        const role = document.querySelector('input[name="role"]:checked').value;
        const includeInLists = document.getElementById('include-in-lists').checked;
        
        // Validate required fields
        if (!givenName || !email || !country) {
            alert('{% trans "Iltimos, barcha majburiy maydonlarni toldiring." %}');
            return;
        }
        
        // Create contributor object
        const contributor = {
            given_name: givenName,
            family_name: familyName,
            preferred_name: preferredName,
            email: email,
            country: country,
            homepage: homepage,
            orcid: orcid,
            bio: bio,
            affiliation: affiliation,
            role: role,
            include_in_lists: includeInLists
        };
        
        // Add to contributors array
        contributors.push(contributor);
        
        // Render contributors
        renderContributors();
        
        // Close modal
        closeContributorModal();
    }
    
    function renderContributors() {
        const contributorsList = document.getElementById('contributors-list');
        contributorsList.innerHTML = '';
        
        contributors.forEach((contributor, index) => {
            const contributorCard = document.createElement('div');
            contributorCard.className = 'contributor-card';
            contributorCard.innerHTML = `
                <button type="button" class="remove-contributor" data-index="${index}">{% trans "O'chirish" %}</button>
                <div class="contributor-info">
                    <span class="contributor-label">{% trans "Ism:" %}</span> ${contributor.given_name}
                </div>
                <div class="contributor-info">
                    <span class="contributor-label">{% trans "Familiya:" %}</span> ${contributor.family_name || '-'}
                </div>
                <div class="contributor-info">
                    <span class="contributor-label">{% trans "Email:" %}</span> ${contributor.email}
                </div>
                <div class="contributor-info">
                    <span class="contributor-label">{% trans "Davlat:" %}</span> ${contributor.country}
                </div>
                <div class="contributor-info">
                    <span class="contributor-label">{% trans "Tashkilot:" %}</span> ${contributor.affiliation || '-'}
                </div>
            `;
            contributorsList.appendChild(contributorCard);
        });
        
        // Add event listeners to remove buttons
        document.querySelectorAll('.remove-contributor').forEach(button => {
            button.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                contributors.splice(index, 1);
                renderContributors();
            });
        });
    }
    
    // Event listeners
    continueBtn.addEventListener('click', nextStep);
    backBtn.addEventListener('click', prevStep);
    
    // Save draft buttons
    saveLaterBtns.forEach(button => {
        button.addEventListener('click', saveDraft);
    });
    
    // Submit button
    submitBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (validateAllSteps()) {
            alert('{% trans "Iltimos, yuborishdan oldin barcha xatolarni tuzating.');
            return;
        }
        
        // Add hidden input for submit type
        const submitTypeInput = document.createElement('input');
        submitTypeInput.type = 'hidden';
        submitTypeInput.name = 'submit_type';
        submitTypeInput.value = 'submit';
        form.appendChild(submitTypeInput);
        
        // Add contributors to form
        contributors.forEach((contributor, index) => {
            const contributorInput = document.createElement('input');
            contributorInput.type = 'hidden';
            contributorInput.name = 'contributors[]';
            contributorInput.value = JSON.stringify(contributor);
            form.appendChild(contributorInput);
        });
        
        // Submit the form
        form.submit();
    });
    
    // File upload
    document.getElementById('add-file-btn').addEventListener('click', function() {
        document.getElementById('id_files').click();
    });
    
    document.getElementById('id_files').addEventListener('change', function() {
        handleFileUpload(this.files);
    });
    
    // Contributor modal
    document.getElementById('add-contributor-btn').addEventListener('click', openContributorModal);
    document.querySelector('.close-modal').addEventListener('click', closeContributorModal);
    document.getElementById('save-contributor-btn').addEventListener('click', saveContributor);
    
    // Edit buttons in review step
    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function() {
            const section = parseInt(this.getAttribute('data-section'));
            currentStep = section - 1;
            updateStepVisibility();
            updateProgressBar();
            updateButtons();
            window.scrollTo(0, 0);
        });
    });
    
    // Initialize the form
    initForm();
});
</script>
<script src="{% static 'js/jquery-1.11.0.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
    crossorigin="anonymous"></script>
<script src="{% static 'js/plugins.js' %}"></script>
<script src="{% static 'js/script.js' %}"></script>
{% endblock %}